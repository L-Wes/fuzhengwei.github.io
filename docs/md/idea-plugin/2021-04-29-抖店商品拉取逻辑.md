##### 线程池

```java
package com.wanmi.sbc.goods.doudiangoodspullrecord.service;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.scheduling.annotation.EnableAsync;
import org.springframework.scheduling.concurrent.CustomizableThreadFactory;

import java.util.concurrent.*;

/**
 * <p>抖店商品同步线程池</P>
 * @ClassName DoudianGoodsPullPool
 * 
 * @author liuwei 
 * @Date 2021/4/23 11:05
 */
@Configuration
@EnableAsync
public class DoudianGoodsPullPool {
    private static final int CORE_POOL_SIZE = 4;
    private static final String THREAD_NAME = "doudianGoodsPull";
    private static final int MAXI_NUM_SIZE = 15;
    private static final int KEEP_ALIVE_TIME = 30;
    private static final int LINK_BLOCK_QUEUE_SIZE = 1000;


    private LinkedBlockingQueue doudianPullBlockingQueue;

    @Bean(name = "doudianGoodsPull")
    public ExecutorService myExecutor(){
        doudianPullBlockingQueue = new LinkedBlockingQueue<Runnable>(LINK_BLOCK_QUEUE_SIZE);
        ThreadFactory factory = new CustomizableThreadFactory(THREAD_NAME);
        ThreadPoolExecutor executor = new ThreadPoolExecutor(
                CORE_POOL_SIZE,
                MAXI_NUM_SIZE,
                KEEP_ALIVE_TIME,
                TimeUnit.SECONDS,
                doudianPullBlockingQueue,
                Executors.defaultThreadFactory(),
                new ThreadPoolExecutor.AbortPolicy());
        executor.allowCoreThreadTimeOut(true);
        return executor;
    }
}
```



##### Service层

```java
package com.wanmi.sbc.goods.doudiangoodspullrecord.service;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.wanmi.sbc.common.base.BaseResponse;
import com.wanmi.sbc.common.base.MicroServicePage;
import com.wanmi.sbc.common.enums.BoolFlag;
import com.wanmi.sbc.common.enums.DefaultFlag;
import com.wanmi.sbc.common.enums.DeleteFlag;
import com.wanmi.sbc.common.enums.IsBoss;
import com.wanmi.sbc.common.exception.SbcRuntimeException;
import com.wanmi.sbc.common.util.CodeUtils;
import com.wanmi.sbc.common.util.KsBeanUtil;
import com.wanmi.sbc.doudian.api.provider.goods.DouDianGoodsProvider;
import com.wanmi.sbc.doudian.api.request.goods.DouDianGoodsListRequest;
import com.wanmi.sbc.doudian.api.response.goods.DouDianGoodsListResponse;
import com.wanmi.sbc.doudian.bean.vo.*;
import com.wanmi.sbc.goods.api.constant.DoudianGoodsPullConst;
import com.wanmi.sbc.goods.api.constant.DoudianGoodsPullErrorCode;
import com.wanmi.sbc.goods.api.request.doudiangoodspull.DoudianGoodsPullInfoRequest;
import com.wanmi.sbc.goods.api.request.shopgoodssync.ShopGoodsSyncCheckRequest;
import com.wanmi.sbc.goods.api.request.shopgoodssync.ShopGoodsSyncQueryRequest;
import com.wanmi.sbc.goods.bean.enums.*;
import com.wanmi.sbc.goods.bean.vo.ShopGoodsPageVO;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianGoodsCategoryDetailRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianPullFailReasonRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianGoodsPullRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianSkuPullRecord;
import com.wanmi.sbc.goods.goodimgrelation.model.root.GoodImgRelation;
import com.wanmi.sbc.goods.goodimgrelation.repository.GoodImgRelationRepository;
import com.wanmi.sbc.goods.goodsinfosalerel.model.root.GoodsInfoSaleRel;
import com.wanmi.sbc.goods.goodsinfosalerel.service.GoodsInfoSaleRelService;
import com.wanmi.sbc.goods.goodsproperty.model.root.GoodsProperty;
import com.wanmi.sbc.goods.goodsproperty.service.GoodsPropertyService;
import com.wanmi.sbc.goods.goodsproprelation.model.root.GoodsPropRelation;
import com.wanmi.sbc.goods.goodsproprelation.service.GoodsPropRelationService;
import com.wanmi.sbc.goods.goodssale.model.root.GoodsSale;
import com.wanmi.sbc.goods.goodssale.service.GoodsSaleService;
import com.wanmi.sbc.goods.goodssalerel.model.root.GoodsSaleRel;
import com.wanmi.sbc.goods.goodssalerel.service.GoodsSaleRelService;
import com.wanmi.sbc.goods.goodssalevalue.model.root.GoodsSaleValue;
import com.wanmi.sbc.goods.goodssalevalue.service.GoodsSaleValueService;
import com.wanmi.sbc.goods.goodsspurecord.modal.root.GoodsRecord;
import com.wanmi.sbc.goods.goodsspurecord.service.GoodsRecordService;
import com.wanmi.sbc.goods.images.GoodsImage;
import com.wanmi.sbc.goods.images.GoodsImageRepository;
import com.wanmi.sbc.goods.info.model.root.Goods;
import com.wanmi.sbc.goods.info.model.root.GoodsInfo;
import com.wanmi.sbc.goods.info.repository.GoodsInfoRepository;
import com.wanmi.sbc.goods.info.repository.GoodsRepository;
import com.wanmi.sbc.goods.info.request.GoodsQueryRequest;
import com.wanmi.sbc.goods.info.service.GoodsInfoService;
import com.wanmi.sbc.goods.info.service.GoodsService;
import com.wanmi.sbc.goods.redis.RedisService;
import com.wanmi.sbc.setting.api.provider.qualification.QualificationManagementQueryProvider;
import com.wanmi.sbc.setting.api.provider.qualification.QualificationManagementSaveProvider;
import com.wanmi.sbc.setting.api.request.qualification.QualificationManagementAddOneRequest;
import com.wanmi.sbc.setting.api.request.qualification.QualificationManagementPageRequest;
import com.wanmi.sbc.setting.api.response.qualification.QualificationManagementGetByIdResponse;
import com.wanmi.sbc.setting.bean.dto.QualificationManagementDTO;
import com.wanmi.sbc.setting.bean.enums.QualificationChangeType;
import com.wanmi.sbc.setting.bean.enums.QualificationStatus;
import com.wanmi.sbc.setting.bean.vo.QualificationManagementVO;
import feign.RetryableException;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.dao.IncorrectResultSizeDataAccessException;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ObjectUtils;
import org.springframework.web.bind.annotation.RequestBody;

import javax.validation.Valid;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.*;
import java.util.concurrent.atomic.AtomicLong;
import java.util.stream.Collectors;
import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.concurrent.*;
import java.util.concurrent.atomic.AtomicInteger;

/**
 * <p>抖店商品信息同步服务实现</p>
 *
 * @author liuwei
 * @date 2021-04-20 20:16:09
 */
@Slf4j
@Service
public class DoudianGoodsPullService {
    @Autowired
    private DoudianGoodsPullRecordService doudianGoodsPullRecordService;

    @Autowired
    private RedisService redisService;

    @Autowired
    private DoudianGoodsPullPool doudianGoodsPullPool;

    @Autowired
    private DouDianGoodsProvider douDianGoodsProvider;

    @Autowired
    private DoudianSkuPullRecordService doudianSkuPullRecordService;

    @Autowired
    private GoodsService goodsService;

    @Autowired
    private GoodsRepository goodsRepository;

    @Autowired
    private GoodsRecordService goodsRecordService;

    @Autowired
    private GoodsImageRepository goodsImageRepository;

    @Autowired
    private GoodsSaleRelService goodsSaleRelService;

    @Autowired
    private GoodsSaleService goodsSaleService;

    @Autowired
    private GoodsSaleValueService goodsSaleValueService;

    @Autowired
    private GoodsPropertyService goodsPropertyService;

    @Autowired
    private GoodsPropRelationService goodsPropRelationService;

    @Autowired
    private GoodsInfoService goodsInfoService;

    @Autowired
    private GoodsInfoSaleRelService goodsInfoSaleRelService;

    @Autowired
    private QualificationManagementSaveProvider qualificationManagementSaveProvider;

    @Autowired
    private QualificationManagementQueryProvider qualificationManagementQueryProvider;

    @Autowired
    private GoodImgRelationRepository goodImgRelationRepository;

    @Autowired
    private GoodsInfoRepository goodsInfoRepository;

    @Autowired
    private DoudianPullFailReasonRecordService doudianPullFailReasonRecordService;

    public static final String LINK_HEAD = "https://sf3-ttcdn-tos.pstatp.com/obj/";

    private AtomicLong count = new AtomicLong(0);

    public void pullDoudianGoods(@RequestBody @Valid DoudianGoodsPullInfoRequest request) {
        log.info("店铺{}抖店商品同步start ===========================", request.getShopInfoId());
        //创建线程池
        ExecutorService executorService = doudianGoodsPullPool.myExecutor();
        String appKey = request.getAppKey();
        String appSecret = request.getAppSecret();
        String accessToken = request.getAccessToken();
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
        String failRedisKey = DoudianGoodsPullConst.PULL_FAIL_ID_LIST_KEY + request.getShopInfoId();
        redisService.delete(failRedisKey);
        //获取抖店商品
        DouDianGoodsPageNewVO pageVO = doudianGoodsPullRecordService.pullDouDianGoodNew(appKey, appSecret, accessToken, 1, 1);
        /*int pageSize = 50;
        DouDianGoodsPageVO pageVO = mockDoudian(appKey, appSecret, 0, pageSize);*/

        //商品总数
        Long total = pageVO.getTotal();
        //每页数据大小，总数大于100则每次查询数为100条，小于100则每次查询数设为10条
        int pageSize = total >= 100 ? 100 : 10;
        //总页数 = （总记录数 + 每页数据大小  - 1） / 每页数据大小
        Long pageNum = (total + pageSize - 1) / pageSize;

        //设置计数器，每同步一个减1
        count.set(total);
        //统计同步商品总数
        log.info("店铺{}商品同步总数：{} -------------- ", request.getShopInfoId(), total);
        redisService.hset(redisKey, DoudianGoodsPullConst.PULL_GOODS_TOTAL_FIELD, String.valueOf(total));

        log.info("店铺{}商品同步分页数：{} -------------- ", request.getShopInfoId(), pageNum);
        redisService.hset(redisKey, DoudianGoodsPullConst.PULL_ALL_PAGES_FIELD, String.valueOf(pageNum));

        // 多线程方式
        List<DoudianPullGoodsTask> taskList = new ArrayList<>();

        //循环获取抖店商品分页
        for (int i = 1; i <= pageNum; i++) {
            taskList.add(new DoudianPullGoodsTask(
                    this,
                    doudianGoodsPullRecordService,
                    redisService,
                    doudianPullFailReasonRecordService,
                    request, count, appKey, appSecret, i, pageSize
            ));

//                DouDianGoodsPageVO doudianGoodsVo = doudianGoodsPullRecordService.pullDouDianGood(appKey, appSecret, i);
//                DouDianGoodsPageVO doudianGoodsVo = mockDoudian(appKey, appSecret, i);
//
//                List<DouDianGoodsVO> goodsListData = doudianGoodsVo.getData();
//
//                //批量保存填充抖店SPU信息
//                log.info("批量保存SPU信息到mongo:第" + i + "页,共{} -------------- ", goodsListData.size());
//                List<DoudianGoodsPullRecord> goodsPullRecords = doudianGoodsPullRecordService.handleSpuData(goodsListData);
//                // TODO 100 下发消息
////                //启用线程池，进行数据处理
//                this.threadOper(request, goodsPullRecords, executor);
//                // TODO MQ  让每台机器去处理吗


        }
        List<Future<Integer>> futures = null;
        try {
            futures = executorService.invokeAll(taskList);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }
//        for (Future<Integer> future : futures) {
//            try {
//                future.get();
//            } catch (InterruptedException e) {
//                e.printStackTrace();
//            } catch (ExecutionException e) {
//                e.printStackTrace();
//            }
//        }
    }

    /**
     * 使用线程池调用service方法进行数据处理
     *
     * @param request             请求参数
     * @param executor            线程
     * @param goodsPullRecordList 从抖店拉取的商品列表
     */
    public void threadOper(DoudianGoodsPullInfoRequest request, List<DoudianGoodsPullRecord> goodsPullRecordList, ExecutorService executor) {
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
        String failRedisKey = DoudianGoodsPullConst.PULL_FAIL_ID_LIST_KEY + request.getShopInfoId();
//        try {
        executor.submit(() -> {
            goodsPullRecordList.forEach(goodsPullRecord -> {

                String productId = goodsPullRecord.getProductId();
                try {
                    doudianGoodsPullRecordService.handleData(request, goodsPullRecord);
                    //记录成功数
                    log.info("同步成功:抖店商品id:{} --------------", productId);
                    redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_SUCCESS_COUNT_FIELD, 1L);
                    //
                } catch (Exception e) {
                    // TODO 所有任务结束后 标志结束
                    //记录失败id
                    log.error("同步失败:抖店商品id:" + productId + "{} --------------", e);
                    redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_FAIL_COUNT_FIELD, 1L);
                    redisService.hset(failRedisKey, productId, e.getMessage());
//
//                        String pullStatusKey = DoudianGoodsPullConst.PULL_STATUS_KEY + request.getShopInfoId();
//                        redisService.hget(pullStatusKey)
//                        if (){

//                        }

                } finally {
                    if (count.decrementAndGet() == 0) {
                        String pullStatusKey = DoudianGoodsPullConst.PULL_STATUS_KEY + request.getShopInfoId();
                        redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_START_FIELD, "0");
                        redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_FINISH_FIELD, "1");
                    }
                }
            });
        });/*.get();
        } catch (InterruptedException e) {
            e.printStackTrace();
        } catch (ExecutionException e) {
            e.printStackTrace();
        }*/
    }


    //mock
    public DouDianGoodsPageVO mockDoudian(String appKey, String appSecret, int page, int pageSize) {
        int total = 5000;
        DouDianGoodsPageVO douDianGoodsPageVO = new DouDianGoodsPageVO();
        douDianGoodsPageVO.setAll("5000");
        douDianGoodsPageVO.setCount(pageSize + "");
        douDianGoodsPageVO.setAll_pages("100");
        DouDianGoodsVO douDianGoodsVO = null;
        List<DouDianGoodsVO> douDianGoodsVOList = new ArrayList<>();
        for (int i = 0; i < pageSize; i++) {
            douDianGoodsVO = new DouDianGoodsVO();
            douDianGoodsVO.setName("抖店商品_" + page + "_" + i);
            douDianGoodsVO.setProduct_id("880000" + page + i);
            douDianGoodsVO.setImg("https://xingye-uat.oss-cn-beijing.aliyuncs.com/a8d8823b961143f3a353216242382e7d.jpg");
            douDianGoodsVO.setDescription("<p>抖店商品！</p>");
            douDianGoodsVO.setMobile("15000000000");
            douDianGoodsVO.setRecommend_remark("商家推荐语");
            douDianGoodsVO.setMarket_price(153L);
            douDianGoodsVO.setDiscount_price(153L);
            douDianGoodsVO.setSettlement_price(153L);
            douDianGoodsVO.setSpec_id("0");
            douDianGoodsVO.setStatus("0");
            douDianGoodsVO.setCheck_status("7");
            douDianGoodsVO.setPay_type("0");
            douDianGoodsVOList.add(douDianGoodsVO);
        }

        douDianGoodsPageVO.setData(douDianGoodsVOList);
        return douDianGoodsPageVO;

    }

    public static class DoudianPullGoodsTask implements Callable<Integer> {
        private final DoudianGoodsPullInfoRequest request;
        private final DoudianGoodsPullService doudianGoodsPullService;
        private final DoudianGoodsPullRecordService doudianGoodsPullRecordService;
        private AtomicLong count;
        private final String appKey;
        private final String appSecret;
        private final int page;
        private final int pageSize;
        private final RedisService redisService;
        private final DoudianPullFailReasonRecordService doudianPullFailReasonRecordService;

        DoudianPullGoodsTask(
                DoudianGoodsPullService doudianGoodsPullService,
                DoudianGoodsPullRecordService doudianGoodsPullRecordService,
                RedisService redisService,
                DoudianPullFailReasonRecordService doudianPullFailReasonRecordService,
                DoudianGoodsPullInfoRequest request,
                AtomicLong count,
                String appKey, String appSecret, int page, int pageSize
        ) {
            this.doudianGoodsPullService = doudianGoodsPullService;
            this.doudianGoodsPullRecordService = doudianGoodsPullRecordService;
            this.count = count;
            this.redisService = redisService;
            this.doudianPullFailReasonRecordService = doudianPullFailReasonRecordService;
            this.request = request;
            this.appKey = appKey;
            this.appSecret = appSecret;
            this.page = page;
            this.pageSize = pageSize;
        }

        /**
         * When an object implementing interface <code>Runnable</code> is used
         * to create a thread, starting the thread causes the object's
         * <code>run</code> method to be called in that separately executing
         * thread.
         * <p>
         * The general contract of the method <code>run</code> is that it may
         * take any action whatsoever.
         *
         * @see Thread#run()
         */
        @Override
        public Integer call() {
            //测试数据
            /*DouDianGoodsPageVO doudianGoodsVo = this.doudianGoodsPullService.
                    mockDoudian(this.appKey, this.appSecret, this.page, this.pageSize);*/

            DouDianGoodsPageNewVO doudianGoodsVo = new DouDianGoodsPageNewVO();
            String accessToken = request.getAccessToken();
            try {
                doudianGoodsVo = doudianGoodsPullRecordService.pullDouDianGoodNew(appKey, appSecret, accessToken, page, pageSize);
            } catch (SbcRuntimeException e) {
                //原子减少失败的数量
                if (count.addAndGet(-pageSize) <= 0) {
                    finishStatus();
                }
                String failReason = "获取商品分页信息失败";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, page, pageSize,FailReasonType.BATCH_FAIL, e);
            } catch (RetryableException e) {
                //原子减少失败的数量
                if (count.addAndGet(-pageSize) <= 0) {
                    finishStatus();
                }
                String failReason = "抖店分页接口超时";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, page, pageSize,FailReasonType.BATCH_FAIL, e);
            } catch (Exception e) {
                //原子减少失败的数量
                if (count.addAndGet(-pageSize) <= 0) {
                    finishStatus();
                }
                String failReason = "其他原因";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, page, pageSize,FailReasonType.BATCH_FAIL, e);
            }
            List<DouDianGoodsNewVO> goodsListData = doudianGoodsVo.getData();

            //批量保存填充抖店SPU信息
            log.info("店铺{}同步分页：第{}页,共{} -------------- ", request.getShopInfoId(), this.page, goodsListData.size());

            String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
//            String failRedisKey = DoudianGoodsPullConst.PULL_FAIL_ID_LIST_KEY + request.getShopInfoId();

            goodsListData.forEach(item -> {
                String productId = item.getProduct_id();
                try {
                    //处理商品数据，并且获取详情，保存到mongo
                    DoudianGoodsPullRecord record = doudianGoodsPullRecordService.handleSpuData(request, productId);
                    doudianGoodsPullRecordService.save(record);

                    //保存商品
                    doudianGoodsPullRecordService.handleData(request, record);

                    //记录成功数
                    log.info("店铺{}同步成功:抖店商品id:{} --------------", request.getShopInfoId(), productId);
                    redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_SUCCESS_COUNT_FIELD, 1L);
                } catch (IncorrectResultSizeDataAccessException e) {
                    String failReason = "保存重复错误";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, page, 1, FailReasonType.SINGLE_FAIL, e);
                } catch (RetryableException e) {
                    String failReason = "抖店接口超时";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, page, 1, FailReasonType.SINGLE_FAIL, e);
                } catch (Exception e) {
                    String failReason = "商品保存失败";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, page, 1, FailReasonType.SINGLE_FAIL, e);
                } finally {
                    // TODO 所有任务结束后 标志结束
                    if (count.decrementAndGet() == 0) {
                        finishStatus();
                    }
                }
            });
            return goodsListData.size();
        }

        //结束更新标志状态
        public void finishStatus() {
            String pullStatusKey = DoudianGoodsPullConst.PULL_STATUS_KEY + request.getShopInfoId();
            redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_START_FIELD, "0");
            redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_FINISH_FIELD, "1");
            log.info("店铺{}抖店商品同步end 第{}页 ===========================", request.getShopInfoId(), this.page);
        }

    }

    /**
     * 失败原因记录，失败数量原子计数 (单个失败)
     * @param shopInfoId 店铺id
     * @param productId 抖店商品id
     * @param failReason 失败原因
     * @param failPageNum 失败页码
     * @param failCount 失败数量
     * @param e 异常信息
     */
    public void failReasonHandle(Integer shopInfoId, String productId, String failReason, Integer failPageNum, Integer failCount,FailReasonType failType, Exception e) {
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + shopInfoId;
        String failRedisKey = DoudianGoodsPullConst.PULL_FAIL_ID_LIST_KEY + shopInfoId;

        DoudianPullFailReasonRecord failInfoRecord = new DoudianPullFailReasonRecord();
        failInfoRecord.setShopInfoId(shopInfoId);
        failInfoRecord.setFailPageNum(failPageNum);
        failInfoRecord.setProductId(productId);
        failInfoRecord.setFailReason(failReason);
        failInfoRecord.setFailCount(failCount);
        failInfoRecord.setFailType(failType);
        failInfoRecord.setFailMessage(e.getMessage());
        failInfoRecord.setCreatTime(LocalDateTime.now());
        failInfoRecord.setDelFlag(DeleteFlag.NO);
        doudianPullFailReasonRecordService.save(failInfoRecord);

        //记录失败id
        if (Objects.isNull(productId)) {
            log.error("店铺{}批量同步第{}页失败:异常信息： {} --------------", shopInfoId, failPageNum, e);
        } else {
            log.error("店铺{}同步失败:抖店商品id:" + productId + "{} --------------", shopInfoId, e);
        }
        redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_FAIL_COUNT_FIELD, Long.valueOf(failCount));
        redisService.hset(failRedisKey, productId, e.getMessage());
    }

    /**
     * 获取抖店商品分页
     */
    public MicroServicePage<ShopGoodsPageVO> doudianGoodsPage(ShopGoodsSyncQueryRequest queryReq){
        String redisPullIdListKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_ID_LIST_KEY + queryReq.getShopInfoId();
        //分页查询抖店商品
        DouDianGoodsListResponse context = douDianGoodsProvider.pageGoods(DouDianGoodsListRequest
                .builder()
                .app_key(queryReq.getAppKey())
                .app_secret(queryReq.getAppSecret())
                .page(String.valueOf(queryReq.getPageNum()))
                .size(String.valueOf(queryReq.getPageSize()))
                .build()).getContext();
        if (context.getErr_no() != 0) {
            log.error("================= 错误码:{}", context.getErr_no());
            log.error("================= 获取抖店分页信息失败:message:{}", context.getMessage());
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.PULL_GOODS_PAGE_FAIL);
        }
        assert context.getData() != null;
        List<DouDianGoodsVO> data = context.getData().getData();
        List<String> productIdList = data.stream().map(DouDianGoodsVO::getProduct_id).collect(Collectors.toList());
        List<Goods> goodsList = goodsRepository.findByDoudianGoodsIds(productIdList);

        List<ShopGoodsPageVO> goodsSyncVOList = new ArrayList<>();
        data.forEach(item -> {
            ShopGoodsPageVO goods = new ShopGoodsPageVO();
            goods.setShopGoodsName(item.getName());
            goods.setGoodsImg(item.getImg());
            goods.setShopGoodsId(item.getProduct_id());
            //判断是否已经在本地存在
            List<Goods> collect = goodsList.stream().filter(g -> item.getProduct_id().equals(g.getDoudianGoodsId())).collect(Collectors.toList());
            goods.setGoodsStatus(CollectionUtils.isEmpty(collect) ? ShopGoodsStatus.NOT_EXIST : ShopGoodsStatus.ALREADY_EXIST);
            //判断是否是处理中
            boolean hasFlag = redisService.sHasKey(redisPullIdListKey, item.getProduct_id());
            goods.setGoodsStatus(hasFlag ? ShopGoodsStatus.BEING_PROCESSED : goods.getGoodsStatus());
            goodsSyncVOList.add(goods);
        });
        MicroServicePage<ShopGoodsPageVO> newPage = new MicroServicePage<>();
        newPage.setContent(goodsSyncVOList);
        newPage.setNumber(Integer.parseInt(context.getData().getCurrent_page()));
        newPage.setSize(Integer.parseInt(context.getData().getPage_size()));
        newPage.setTotal(Long.parseLong(context.getData().getAll()));
        return newPage;
    }

    /**
     * 更新商品时，检查商品信息
     * @param request
     * @return
     */
    public GoodsCheckStatus updateGoodsCheck(ShopGoodsSyncCheckRequest request) {
        GoodsQueryRequest goodsQueryRequest = new GoodsQueryRequest();
        goodsQueryRequest.setPageNum(0);
        goodsQueryRequest.setPageSize(1);
        goodsQueryRequest.putSort("createTime", "desc");
        goodsQueryRequest.setDoudianGoodsId(request.getDoudianGoodsId());
        List<Goods> all = goodsService.findAll(goodsQueryRequest);
        Goods oldGoods = all.stream().findFirst().orElse(new Goods());


        DouDianSkuListVO douDianSkuListVO = doudianGoodsPullRecordService.pullDoudianSkuList(request.getAppKey(), request.getAppSecret(), request.getDoudianGoodsId(), request.getAccess_token());
        List<DouDianSkuListDataVO> data = douDianSkuListVO.getData();
        List<String> doudianSkuIds = data.stream().map(DouDianSkuListDataVO::getId).collect(Collectors.toList());

        List<GoodsInfo> oldGoodsInfos = goodsInfoService.findByGoodsIdAndDelFlag(oldGoods.getGoodsId(), DeleteFlag.NO);
        List<String> olddoudianSkuIds = oldGoodsInfos.stream().map(GoodsInfo::getDoudianSkuId).collect(Collectors.toList());
        if (checkDiffrent(olddoudianSkuIds, doudianSkuIds)) {
            return GoodsCheckStatus.DEFAULT_UPDATE;
        } else {
            return oldGoods.getGoodsStatus() == 3 ? GoodsCheckStatus.COVER : GoodsCheckStatus.CREATE;
        }
    }


    /**
     * 批量获取抖店商品
     */
    @Transactional(value = "JpaTransactionManager" , rollbackFor = Exception.class)
    public void byIdPullGoods(DoudianGoodsPullInfoRequest request) {
        log.info("=========================== 抖店商品同步start ===========================");
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
        String redisPullIdListKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_ID_LIST_KEY + request.getShopInfoId();
        String failRedisKey = DoudianGoodsPullConst.PULL_FAIL_ID_LIST_KEY + request.getShopInfoId();

        List<String> doudianGoodsIds = request.getDoudianGoodsIds();
        //去除已处于处理中的商品id
        Set<String> set = (Set<String>) redisService.sGet(redisPullIdListKey);
        doudianGoodsIds.removeAll(set);
        redisService.sSet(redisPullIdListKey, doudianGoodsIds);

        List<DoudianGoodsPullRecord> goodsPullRecords = new ArrayList<>();
        doudianGoodsIds.forEach(doudianGoodsId -> {
            try {
                DouDianGoodsDetailVO douDianGoodsDetailVO = doudianGoodsPullRecordService.pullDoudianDetail(request.getAppKey(), request.getAppSecret(), doudianGoodsId, request.getAccessToken());
                DouDianGoodsDetailDataVO spuDetailData = douDianGoodsDetailVO.getData();
                //封装抖店商品数据到临时表
                DoudianGoodsPullRecord goodsPullRecord = this.handleDoudianSPU(spuDetailData);
                goodsPullRecords.add(goodsPullRecord);
                doudianGoodsPullRecordService.save(goodsPullRecord);
                //抖店商品落库
                saveDoudianGoods(request ,goodsPullRecord, spuDetailData);
                //记录成功数
                log.info("同步成功:抖店商品id:{} --------------", doudianGoodsId);
                redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_SUCCESS_COUNT_FIELD, 1L);
            } catch (Exception e) {
                //记录失败id
                log.error("同步失败:抖店商品id:" + doudianGoodsId + "{} --------------", e);
                redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_FAIL_COUNT_FIELD, 1L);
                redisService.hset(failRedisKey, doudianGoodsId, e.getMessage());
            }finally {
                redisService.setRemove(redisPullIdListKey, doudianGoodsId);
                log.info("=========================== 共{} 抖店商品同步end ===========================", goodsPullRecords.size());
            }
        });
    }

    /**
     * 处理抖店商品SPU数据
     *
     * @return
     */
    public DoudianGoodsPullRecord handleDoudianSPU(DouDianGoodsDetailDataVO spuDetailData) {

        DoudianGoodsPullRecord goodsPullRecord = new DoudianGoodsPullRecord();
        goodsPullRecord.setProductId(spuDetailData.getProduct_id());
        goodsPullRecord.setOutProductId(spuDetailData.getOut_product_id());
        goodsPullRecord.setOuterProductId(spuDetailData.getOuter_product_id());
        goodsPullRecord.setName(spuDetailData.getName());
        goodsPullRecord.setImg(spuDetailData.getImg());
        goodsPullRecord.setDescription(spuDetailData.getDescription());
        goodsPullRecord.setMobile(spuDetailData.getMobile());
        goodsPullRecord.setRecommendRemark(spuDetailData.getRecommend_remark());
        goodsPullRecord.setMarketPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getMarket_price()).orElse(0L)));
        goodsPullRecord.setDiscountPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getDiscount_price()).orElse(0L) / 100));
        goodsPullRecord.setSettlementPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getSettlement_price()).orElse(0L)));
        goodsPullRecord.setSpecId(Objects.isNull(spuDetailData.getSpec_id()) ? null : Long.valueOf(spuDetailData.getSpec_id()));
        //填充旧类目id
        goodsPullRecord.setFirstCid(spuDetailData.getFirst_cid());
        goodsPullRecord.setSecondCid(spuDetailData.getSecond_cid());
        goodsPullRecord.setThirdCid(spuDetailData.getThird_cid());
        //填充新的类目
        if (Objects.nonNull(spuDetailData.getCategory_detail())) {
            DoudianGoodsCategoryDetailRecord categoryDetail = new DoudianGoodsCategoryDetailRecord();
            categoryDetail.setFirstCid(spuDetailData.getCategory_detail().getFirst_cid());
            categoryDetail.setSecondCid(spuDetailData.getCategory_detail().getSecond_cid());
            categoryDetail.setThirdCid(spuDetailData.getCategory_detail().getThird_cid());
            categoryDetail.setFourthCid(spuDetailData.getCategory_detail().getFourth_cid());
            categoryDetail.setFirstCname(spuDetailData.getCategory_detail().getFirst_cname());
            categoryDetail.setSecondCname(spuDetailData.getCategory_detail().getSecond_cname());
            categoryDetail.setThirdCname(spuDetailData.getCategory_detail().getThird_cname());
            categoryDetail.setFourthCname(spuDetailData.getCategory_detail().getFourth_cname());
            goodsPullRecord.setCategoryDetail(categoryDetail);
        }
        goodsPullRecord.setStatus(Integer.valueOf(spuDetailData.getStatus()));
        goodsPullRecord.setCheckStatus(Integer.valueOf(spuDetailData.getCheck_status()));
        goodsPullRecord.setPayType(Integer.valueOf(spuDetailData.getPay_type()));
        goodsPullRecord.setExtra(spuDetailData.getExtra());
        goodsPullRecord.setCreateTime(spuDetailData.getCreate_time());
        goodsPullRecord.setUpdateTime(spuDetailData.getUpdate_time());

        if (StringUtils.isNotEmpty(spuDetailData.getProduct_format())) {
            String replace = spuDetailData.getProduct_format().replace("{", "").replace("}", "")
                    .replace(":", "|").replace("\"", "");
            if (StringUtils.isNotEmpty(replace)) {
                goodsPullRecord.setProductFormat(replace);
            }
        }
        goodsPullRecord.setPic(spuDetailData.getPic());
        goodsPullRecord.setPresellType(Integer.valueOf(spuDetailData.getPay_type()));
        goodsPullRecord.setMaximumPerOrder(spuDetailData.getMaximum_per_order());
        goodsPullRecord.setLimitPerBuyer(spuDetailData.getLimit_per_buyer());
        goodsPullRecord.setMinimumPerOrder(spuDetailData.getMinimum_per_order());
        goodsPullRecord.setSpecs(spuDetailData.getSpecs());
        goodsPullRecord.setSpecPics(spuDetailData.getSpec_pics());

        return goodsPullRecord;
    }

    /**
     * 保存抖店商品
     */
    public void saveDoudianGoods(DoudianGoodsPullInfoRequest request, DoudianGoodsPullRecord goodsPullRecord, DouDianGoodsDetailDataVO spuDetailData) {
        Goods firstOldGoods = new Goods();
        GoodsSaveType goodsSaveType = request.getGoodsSaveType();

        if (GoodsSaveType.UPDATE.equals(goodsSaveType) || GoodsSaveType.COVER.equals(goodsSaveType)) {
            GoodsQueryRequest goodsQueryRequest = new GoodsQueryRequest();
            goodsQueryRequest.setPageNum(0);
            goodsQueryRequest.setPageSize(1);
            goodsQueryRequest.putSort("createTime", "desc");
            goodsQueryRequest.setDoudianGoodsId(goodsPullRecord.getProductId());
            List<Goods> all = goodsService.findAll(goodsQueryRequest);
            firstOldGoods = all.stream().findFirst().orElse(new Goods());
        }

        //填充SPU数据
        Goods goods = this.handleGoods(request, goodsPullRecord, firstOldGoods);
        KsBeanUtil.copyPropertiesIgnoreNull(goods, firstOldGoods);
        Goods saveGoods = goodsService.add(firstOldGoods);
        GoodsRecord goodsRecord = KsBeanUtil.convert(saveGoods, GoodsRecord.class);

        //添加商品图片
        if (GoodsSaveType.NEW.equals(goodsSaveType)) {
            List<GoodsImage> goodsImages = new ArrayList<>();
            if (CollectionUtils.isNotEmpty(goodsPullRecord.getPic())) {
                goodsPullRecord.getPic().stream().forEach(img -> {
                    GoodsImage goodsImage = new GoodsImage();
                    goodsImage.setArtworkUrl(img);
                    goodsImage.setGoodsId(saveGoods.getGoodsId());
                    goodsImage.setDelFlag(DeleteFlag.NO);
                    goodsImage.setCreateTime(LocalDateTime.now());
                    goodsImage.setUpdateTime(LocalDateTime.now());
                    goodsImages.add(goodsImage);
                });
            }
            List<GoodsImage> goodsImages1 = goodsImageRepository.saveAll(goodsImages);
            goodsRecord.setGoodsImages(goodsImages1);
        }

        //添加规格
        List<GoodsSaleRel> saleRelList = new ArrayList<>();
        List<GoodsSaleValue> saleValueList = new ArrayList<>();
        List<DouDianSpecDetailVO> specs = spuDetailData.getSpecs();
        if (CollectionUtils.isNotEmpty(specs)) {
            this.handleSpuSale(saveGoods, specs, saleRelList, saleValueList);
            goodsSaleRelService.addAll(saleRelList);
        }
        goodsRecord.setGoodsSaleRels(saleRelList);

        //添加商品属性
        List<GoodsPropRelation> propRelationList = new ArrayList<>();
        if (StringUtils.isNotBlank(goodsPullRecord.getProductFormat())) {
            this.handleProp(goodsPullRecord, goodsSaveType, saveGoods, propRelationList);
        }
        goodsRecord.setPropRelationList(propRelationList);

        String extra = goodsPullRecord.getExtra();
        //资质信息落库
        if (Objects.nonNull(extra)) {
            saveQualification(request, saveGoods, extra);
        }
        //如果是新增才存入mongo，用于数据对比
        if (GoodsSaveType.NEW.equals(goodsSaveType)) {
            //资质审核后才放入mongodb
            goodsRecord.setGoodImgRelations(new ArrayList<>());
            goodsRecordService.save(goodsRecord);
        }

        //获取spu关联的sku列表
        DouDianSkuListVO douDianSkuListVO = doudianGoodsPullRecordService.pullDoudianSkuList(request.getAppKey(), request.getAppSecret(), goodsPullRecord.getProductId(), request.getAccessToken());
        //处理抖店sku数据
        List<DoudianSkuPullRecord> goodsInfoRecordList = doudianGoodsPullRecordService.handleSkuData(douDianSkuListVO.getData());
        doudianSkuPullRecordService.saveAll(goodsInfoRecordList);

        List<GoodsInfo> goodsInfoList = new ArrayList<>();
        List<SpecPicVO> specPics = goodsPullRecord.getSpecPics();
        //判断sku是新建还是覆盖
        if (GoodsSaveType.UPDATE.equals(goodsSaveType)) {
            List<GoodsInfo> oldGoodsInfos = goodsInfoService.findByGoodsIdAndDelFlag(firstOldGoods.getGoodsId(), DeleteFlag.NO);
            goodsInfoRecordList.forEach(skuPullRecord -> {
                oldGoodsInfos.forEach(goodsInfo -> {
                    if (skuPullRecord.getId().equals(goodsInfo.getOutSkuNo())) {
                        GoodsInfo oldGoodsInfo = this.handleSku(goodsInfo, saveGoods, skuPullRecord);
                        goodsInfoList.add(oldGoodsInfo);
                    }
                });
            });
        } else if (GoodsSaveType.COVER.equals(goodsSaveType)) {
            //覆盖先删除旧sku再新建
            List<GoodsInfo> oldGoodsInfos = goodsInfoService.findByGoodsIdAndDelFlag(firstOldGoods.getGoodsId(), DeleteFlag.NO);
            List<String> olddoudianSkuIds = oldGoodsInfos.stream().map(GoodsInfo::getDoudianSkuId).collect(Collectors.toList());
            goodsInfoService.deleteSkuList(olddoudianSkuIds);
            goodsInfoRecordList.forEach(skuPullRecord -> {
                GoodsInfo oldGoodsInfo = this.handleSku(new GoodsInfo(), saveGoods, skuPullRecord);
                goodsInfoList.add(oldGoodsInfo);
            });
        } else if (GoodsSaveType.NEW.equals(goodsSaveType)) {
            goodsInfoRecordList.forEach(skuPullRecord -> {
                GoodsInfo oldGoodsInfo = this.handleSku(new GoodsInfo(), saveGoods, skuPullRecord);
                goodsInfoList.add(oldGoodsInfo);
            });
        }

        //如果sku不是新增，则删除旧规格关联关系
        List<String> goodsInfos = goodsInfoList.stream().map(GoodsInfo::getGoodsInfoId).collect(Collectors.toList());
        if (CollectionUtils.isNotEmpty(goodsInfos)) {
            goodsInfoSaleRelService.deleteByGoodsInfoIds(goodsInfos, saveGoods.getGoodsId());
            //删除sku图片
            goodsImageRepository.deleteByGoodsInfoIds(goodsInfos);
        }

        //保存sku
        List<GoodsInfo> saveGoodsInfos = goodsInfoService.batchSave(goodsInfoList);

        //sku图片
        List<GoodsImage> goodsInfoImageList = new ArrayList<>();
        //sku规格关联
        List<GoodsInfoSaleRel> goodsInfoSaleRelList = new ArrayList<>();
        Map<String, GoodsInfo> saveSkuMap = saveGoodsInfos.stream().collect(Collectors.toMap(GoodsInfo::getDoudianSkuId, g->g));
        goodsInfoRecordList.forEach(item -> {
            //sku图片
            if (CollectionUtils.isNotEmpty(specPics)) {
                specPics.stream()
                        .filter(specPic ->
                                StringUtils.equalsAny(specPic.getSpec_detail_id(), item.getSpecDetailId1(), item.getSpecDetailId2(), item.getSpecDetailId3()))
                        .forEach(specPic->{
                            GoodsImage goodsImage = new GoodsImage();
                            goodsImage.setGoodsInfoId(saveSkuMap.get(item.getId()).getGoodsInfoId());
                            goodsImage.setDelFlag(DeleteFlag.NO);
                            String artworkUrl = LINK_HEAD + specPic.getPic();
                            goodsImage.setArtworkUrl(artworkUrl);
                            goodsImage.setCreateTime(LocalDateTime.now());
                            goodsInfoImageList.add(goodsImage);
                            goodsInfoRepository.updateGoodsInfoImg(saveSkuMap.get(item.getId()).getGoodsInfoId(), artworkUrl);
                        });
            }

            //保存sku规格关联关系
            saleValueList.forEach(saleValue -> {
                GoodsInfo goodsInfo = saveSkuMap.get(item.getId());
                if (StringUtils.isNotBlank(item.getSpecDetailName1()) && saleValue.getSaleName().equals(item.getSpecDetailName1())) {
                    //插入中间表
                    goodsInfoSaleRelList.add(this.handleSkuSaleRel(goodsInfo, saleValue));
                }

                if (StringUtils.isNotBlank(item.getSpecDetailName2()) && saleValue.getSaleName().equals(item.getSpecDetailName2())) {
                    //插入中间表
                    goodsInfoSaleRelList.add(this.handleSkuSaleRel(goodsInfo, saleValue));
                }

                if (StringUtils.isNotBlank(item.getSpecDetailName3()) && saleValue.getSaleName().equals(item.getSpecDetailName3())) {
                    //插入中间表
                    goodsInfoSaleRelList.add(this.handleSkuSaleRel(goodsInfo, saleValue));
                }
            });
        });
        //保存sku图片
        goodsImageRepository.saveAll(goodsInfoImageList);

        //保存sku规格关联关系
        goodsInfoSaleRelService.batchSave(goodsInfoSaleRelList);

    }

    /**
     * Goods数据处理
     */
    public Goods handleGoods(DoudianGoodsPullInfoRequest request, DoudianGoodsPullRecord goodsPullRecord, Goods oldGoods) {
        Goods goods = new Goods();
        goods.setMoreSpecFlag(DefaultFlag.YES.toValue());
        goods.setCompanyType(BoolFlag.YES);
        goods.setGoodsOrigin(DefaultFlag.YES);
        goods.setDoudianGoodsId(goodsPullRecord.getProductId());
        goods.setOriginStoreName(request.getShopName());
        goods.setGoodsName(goodsPullRecord.getName());
        goods.setGoodsImg(goodsPullRecord.getImg());
        goods.setGoodsDetail(goodsPullRecord.getDescription());
        goods.setGoodsSuggestions(goodsPullRecord.getRecommendRemark());
        goods.setLinePrice(goodsPullRecord.getMarketPrice());
        goods.setTiktokSellPrice(goodsPullRecord.getDiscountPrice());
        goods.setPresellType(goodsPullRecord.getPresellType());
        goods.setUpdateTime(LocalDateTime.now());
        goods.setDoudianShopInfoId(request.getShopInfoId());

        //第一次拉取，新增字段
        if (Objects.isNull(oldGoods.getGoodsId())) {
            goods.setGoodsType(DefaultFlag.NO.toValue());
            goods.setGoodsAuditStatus(GoodsAuditStatus.INITIAL_STATE);
            goods.setGoodsStatus(3);

            String systemProviderGoodsCode = CodeUtils.getSystemProviderGoodsCode();
            goods.setGoodsNo(systemProviderGoodsCode);

            goods.setSaleType(1);
            goods.setCateId(0L);
            goods.setDelFlag(DeleteFlag.NO);
            goods.setAddedFlag(0);
            goods.setStoreId(request.getStoreVO().getStoreId());
            goods.setAddedTimingFlag(Boolean.FALSE);
            goods.setCompanyInfoId(request.getStoreVO().getCompanyInfo().getCompanyInfoId());
            goods.setSupplierName(request.getStoreVO().getCompanyInfo().getCompanyName());
            goods.setAuditStatus(CheckStatus.WAIT_CHECK);
            goods.setCreateTime(LocalDateTime.now());
        } else {
            //判断商品字段更改，不同则变更状态
            if ( !checkGoodsDiffrent(oldGoods, goodsPullRecord)) {
                //状态处于 新建待审核、新建被驳回、资质待审核时，变更为新建待审核
                switch (oldGoods.getGoodsAuditStatus()) {
                    case NEW_WAIT_CHECK://新建待审核
                        goods.setGoodsAuditStatus(GoodsAuditStatus.NEW_WAIT_CHECK);
                        break;
                    case NEW_NOT_PASS://新建被驳回
                        goods.setGoodsAuditStatus(GoodsAuditStatus.NEW_WAIT_CHECK);
                        break;
                    case QUALIFICATION_WAIT_CHECK://资质待审核
                        goods.setGoodsAuditStatus(GoodsAuditStatus.NEW_WAIT_CHECK);
                        break;
                    case AUDIT_WAIT_CHECK://编辑待审核
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case FORIBID_WAIT_CHECK://停用待审核
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case ENABLE_WAIT_CHECK://启用待审核
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case AUDIT_NOT_PASS://编辑被驳回
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case FORIBID_NOT_PASS://停用被驳回
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case ENABLE_NOT_PASS://启用被驳回
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                    case PASS://审核通过
                        goods.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
                        break;
                }
            }

        }
        return goods;
    }

    /**
     * 商品规格数据处理
     */
    public void handleSpuSale(Goods saveGoods, List<DouDianSpecDetailVO> specs, List<GoodsSaleRel> saleRelList, List<GoodsSaleValue> saleValueList) {
        //先删除旧规格关联
        goodsSaleRelService.deleteByGoodsId(saveGoods.getGoodsId());
        specs.forEach(specInfo -> {
            if (StringUtils.isBlank(specInfo.getName())) {
                return;
            }
            //根据规格名称获取，不存在则新建
            GoodsSale sale = goodsSaleService.getSale(specInfo.getName());
            if (Objects.isNull(sale)) {
                //新建规格项
                GoodsSale goodsSale = new GoodsSale();
                goodsSale.setSaleTypeName(specInfo.getName());
                goodsSale.setCreateTime(LocalDateTime.now());
                goodsSale.setUpdateTime(LocalDateTime.now());
                goodsSale.setDelFlag(DeleteFlag.NO);
                List<String> saleValueNameList = specInfo.getValues().stream()
                        .filter(v -> StringUtils.isNotBlank(v.getName()))
                        .map(DouDianSpecDetaiValueVO::getName)
                        .collect(Collectors.toList());
                GoodsSale saveGoodsSale = goodsSaleService.add(goodsSale, saleValueNameList);
                List<GoodsSaleValue> saveSaleValues = saveGoodsSale.getGoodsSaleValues();
                saleValueList.addAll(saveSaleValues);

                //新建关联中间表
                saveSaleValues.forEach(saveSaleValue -> {
                    GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                    goodsSaleRel.setCreateTime(LocalDateTime.now());
                    goodsSaleRel.setUpdateTime(LocalDateTime.now());
                    goodsSaleRel.setDelFlag(DeleteFlag.NO);
                    goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                    goodsSaleRel.setSaleId(saveGoodsSale.getSaleId());
                    goodsSaleRel.setSaleValueId(saveSaleValue.getSaleValueId());
                    goodsSaleRel.setSaleName(saveGoodsSale.getSaleName());
                    goodsSaleRel.setSaleTypeName(saveGoodsSale.getSaleTypeName());
                    saleRelList.add(goodsSaleRel);
                });

            } else {
                //获取所有过滤的规格值名称
                List<String> saleValueNameList = specInfo.getValues().stream()
                        .filter(v -> StringUtils.isNotBlank(v.getName()))
                        .map(DouDianSpecDetaiValueVO::getName)
                        .collect(Collectors.toList());
                saleValueNameList.forEach(saleValueName -> {
                    if (StringUtils.isBlank(saleValueName)) {
                        return;
                    }
                    //校验规格值是否存在
                    List<GoodsSaleValue> forCheck = goodsSaleValueService.findForCheck(sale.getSaleId(), saleValueName);
                    GoodsSaleValue checkSaleValue = forCheck.stream()
                            .filter(s -> IsBoss.YES.equals(s.getIsBoss()) && s.getSaleName().equals(saleValueName))
                            .findFirst().orElse(null);

                    if (Objects.isNull(checkSaleValue)) {
                        //规格值没有则新建
                        GoodsSaleValue saleValue = new GoodsSaleValue();
                        saleValue.setCreateTime(LocalDateTime.now());
                        saleValue.setUpdateTime(LocalDateTime.now());
                        saleValue.setDelFlag(DeleteFlag.NO);
                        saleValue.setSaleId(sale.getSaleId());
                        saleValue.setSaleName(saleValueName);
                        saleValue.setIsBoss(IsBoss.NO);
                        saleValue.setStoreId(saveGoods.getStoreId());
                        GoodsSaleValue saveSaleValue = goodsSaleValueService.add(saleValue);
                        //为了sku添加规格
                        saleValueList.add(saveSaleValue);
                        //插入中间表
                        GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                        goodsSaleRel.setCreateTime(LocalDateTime.now());
                        goodsSaleRel.setUpdateTime(LocalDateTime.now());
                        goodsSaleRel.setDelFlag(DeleteFlag.NO);
                        goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                        goodsSaleRel.setSaleId(sale.getSaleId());
                        goodsSaleRel.setSaleValueId(saveSaleValue.getSaleValueId());
                        goodsSaleRel.setSaleName(saveSaleValue.getSaleName());
                        goodsSaleRel.setSaleTypeName(sale.getSaleTypeName());
                        saleRelList.add(goodsSaleRel);
                    } else {
                        //为了sku添加规格
                        saleValueList.add(checkSaleValue);
                        //规格值存在，关联中间表
                        GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                        goodsSaleRel.setCreateTime(LocalDateTime.now());
                        goodsSaleRel.setUpdateTime(LocalDateTime.now());
                        goodsSaleRel.setDelFlag(DeleteFlag.NO);
                        goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                        goodsSaleRel.setSaleId(sale.getSaleId());
                        goodsSaleRel.setSaleValueId(checkSaleValue.getSaleValueId());
                        goodsSaleRel.setSaleName(checkSaleValue.getSaleName());
                        goodsSaleRel.setSaleTypeName(sale.getSaleTypeName());
                        saleRelList.add(goodsSaleRel);
                    }

                });
            }
        });
    }

    /**
     * 商品属性数据处理
     */
    public void handleProp(DoudianGoodsPullRecord goodsPullRecord, GoodsSaveType goodsSaveType, Goods saveGoods, List<GoodsPropRelation> propRelationList) {
        String productFormat = goodsPullRecord.getProductFormat();
        String[] values = productFormat.split("\\,");
        for (String v : values) {
            String[] propertySplit = v.split("\\|");
            if (propertySplit.length != 2) {
                continue;
            }
            GoodsProperty byPropName = goodsPropertyService.findByPropName(propertySplit[0], 2);
            //辅助属性项不存在则新增辅助属性
            if (ObjectUtils.isEmpty(byPropName)) {
                GoodsProperty goodsProperty = new GoodsProperty();
                goodsProperty.setRequired(2);
                goodsProperty.setPropType(2);
                goodsProperty.setEnable(1);
                goodsProperty.setPropDetailType(0);
                goodsProperty.setPropName(propertySplit[0]);
                goodsProperty.setGoodsPropertyDetail(new ArrayList<>());
                goodsProperty.setDelFlag(DeleteFlag.NO);
                goodsProperty.setCreateTime(LocalDateTime.now());
                goodsProperty.setUpdateTime(LocalDateTime.now());
                GoodsProperty saveProperty = goodsPropertyService.add(goodsProperty);

                GoodsPropRelation goodsPropRelation = new GoodsPropRelation();
                goodsPropRelation.setPropId(saveProperty.getId());
                goodsPropRelation.setPropValue(propertySplit[1]);
                goodsPropRelation.setPropDetailType(0);
                goodsPropRelation.setPropType(2);
                goodsPropRelation.setCreateTime(LocalDateTime.now());
                goodsPropRelation.setGoodsId(saveGoods.getGoodsId());
                GoodsPropRelation propRelation = goodsPropRelationService.add(goodsPropRelation);
                propRelationList.add(propRelation);
            } else {
                //第一次拉取商品是，关联辅助属性值
                if (GoodsSaveType.NEW.equals(goodsSaveType)) {
                    GoodsPropRelation goodsPropRelation = new GoodsPropRelation();
                    goodsPropRelation.setPropId(byPropName.getId());
                    goodsPropRelation.setPropValue(propertySplit[1]);
                    goodsPropRelation.setPropDetailType(0);
                    goodsPropRelation.setPropType(2);
                    goodsPropRelation.setCreateTime(LocalDateTime.now());
                    goodsPropRelation.setGoodsId(saveGoods.getGoodsId());
                    GoodsPropRelation propRelation = goodsPropRelationService.add(goodsPropRelation);
                    propRelationList.add(propRelation);
                } else {
                    //先删除再做新增
                    goodsPropRelationService.deleteByGoodsId(saveGoods.getGoodsId(), byPropName.getId(), 2, 0);
                    GoodsPropRelation goodsPropRelation = new GoodsPropRelation();
                    goodsPropRelation.setPropId(byPropName.getId());
                    goodsPropRelation.setPropValue(propertySplit[1]);
                    goodsPropRelation.setPropDetailType(0);
                    goodsPropRelation.setPropType(2);
                    goodsPropRelation.setCreateTime(LocalDateTime.now());
                    goodsPropRelation.setGoodsId(saveGoods.getGoodsId());
                    GoodsPropRelation propRelation = goodsPropRelationService.add(goodsPropRelation);
                    propRelationList.add(propRelation);
                }
            }
        }
    }

    /**
     * 商品资质信息入库
     */
    public void saveQualification(DoudianGoodsPullInfoRequest request,Goods saveGoods, String extra) {
        JSONObject extraJson = JSONObject.parseObject(extra);
        //relationQualificationType(0)
        String classQuality = extraJson.getString("class_quality");
        String qualityReport = extraJson.getString("quality_report");
        JSONArray qualityList = extraJson.getJSONArray("quality_list");

        //校验是否存在资质，不存在则结束该方法
        if (CollectionUtils.isEmpty(qualityList) || (StringUtils.isBlank(classQuality) && StringUtils.isBlank(qualityReport)) ) {
            return;
        };

        QualificationManagementDTO goodsQualification = new QualificationManagementDTO();
        StringBuffer sb = new StringBuffer();

        if (StringUtils.isNotBlank(classQuality)) {
            String replace = classQuality.replace(",", "|");
            sb.append(replace).append("|");
        }
        if (StringUtils.isNotBlank(qualityReport)) {
            sb.append(qualityReport).append("|");
        }

        if (sb.length() > 0) {
            sb.deleteCharAt(sb.length() - 1);
        }
        List<QualificationManagementVO> qualificationManagementVOList = qualificationManagementQueryProvider
                .list(QualificationManagementPageRequest
                        .builder()
                        .relationId(saveGoods.getGoodsId())
                        .qualificationType(0)
                        .relationQualificationType(0)
                        .end(1)
                        .storeId(saveGoods.getStoreId())
                        .build())
                .getContext()
                .getQualificationManagementVOList();

        if (org.apache.commons.collections4.CollectionUtils.isNotEmpty(qualificationManagementVOList)) {
            QualificationManagementVO qualificationManagementVO = qualificationManagementVOList.get(0);
            KsBeanUtil.copyPropertiesThird(qualificationManagementVO, goodsQualification);
        }
        goodsQualification.setStatus(QualificationStatus.INIT);
        goodsQualification.setEnd(1);
        goodsQualification.setRelationNo(saveGoods.getGoodsNo());
        goodsQualification.setRelationName(saveGoods.getGoodsName());
        goodsQualification.setQualificationType(0);
        goodsQualification.setCompanyName(request.getStoreVO().getCompanyInfo().getCompanyName());
        goodsQualification.setGoodsType(0);
        goodsQualification.setRelationQualificationType(0);
        goodsQualification.setPicUrl(sb.toString());
        goodsQualification.setRelationId(saveGoods.getGoodsId());
        goodsQualification.setStoreId(saveGoods.getStoreId());
        goodsQualification.setQualificationChangeType(QualificationChangeType.ADD);
        BaseResponse<QualificationManagementGetByIdResponse> qualification = qualificationManagementSaveProvider
                .addOne(QualificationManagementAddOneRequest.builder().qualificationManagementDTO(goodsQualification).build());
        if (Objects.nonNull(qualification.getContext().getQualificationManagementVO())) {
            Integer id = qualification.getContext().getQualificationManagementVO().getId();
            goodsRepository.updateGoodsQulification(saveGoods.getGoodsId(), id);
        }

        goodImgRelationRepository.deleteAllByGoodsId(saveGoods.getGoodsId());
        List<GoodImgRelation> goodImgRelationList = new ArrayList<>();
        //资质图片关联
        for (int i = 0; i < qualityList.size(); i++) {
            JSONObject jsonObject = qualityList.getJSONObject(i);
            JSONArray qualityAttachments = jsonObject.getJSONArray("quality_attachments");
            for (int j = 0; j < qualityAttachments.size(); j++) {
                JSONObject jsonObject1 = qualityAttachments.getJSONObject(j);
                String url = jsonObject1.getString("url");

                GoodImgRelation goodImgRelation = new GoodImgRelation();
                goodImgRelation.setGoodsId(saveGoods.getGoodsId());
                goodImgRelation.setGoodsQualificationImg(url);
                goodImgRelation.setDelFlag(DeleteFlag.NO);
                goodImgRelation.setCreateTime(LocalDateTime.now());
                goodImgRelationList.add(goodImgRelation);
            }
        }
        goodImgRelationRepository.saveAll(goodImgRelationList);

    }

    //检查两个集合是否完全相同
    private static boolean checkDiffrent(List<String> list, List<String> list1) {
        list.sort(Comparator.comparing(String::hashCode));
        list1.sort(Comparator.comparing(String::hashCode));
        return list.toString().equals(list1.toString());
    }

    /**
     * 抖店sku数据处理
     */
    public GoodsInfo handleSku(GoodsInfo oldGoodsInfo, Goods saveGoods, DoudianSkuPullRecord skuPullRecord) {
        GoodsInfo goodsInfo = new GoodsInfo();
        goodsInfo.setDoudianSpuId(saveGoods.getDoudianGoodsId());
        goodsInfo.setDoudianSkuId(skuPullRecord.getId());
        goodsInfo.setDoudianSkuPrice(skuPullRecord.getPrice());
        goodsInfo.setOutSkuNo(skuPullRecord.getId());
        goodsInfo.setGoodsInfoName(saveGoods.getGoodsName());
        goodsInfo.setGoodsId(saveGoods.getGoodsId());
        goodsInfo.setUpdateTime(LocalDateTime.now());

        //是否新增sku
        if (Objects.isNull(oldGoodsInfo.getGoodsInfoId())) {
            goodsInfo.setGoodsAuditStatus(GoodsAuditStatus.INITIAL_STATE);
            goodsInfo.setGoodsInfoNo(CodeUtils.getSystemProviderSkuGoodsCode());
            goodsInfo.setCompanyInfoId(saveGoods.getCompanyInfoId());
            goodsInfo.setStoreId(saveGoods.getStoreId());
            goodsInfo.setAuditStatus(CheckStatus.WAIT_CHECK);
            goodsInfo.setCateId(0L);
            goodsInfo.setAddedTimingFlag(Boolean.FALSE);
            goodsInfo.setAloneFlag(Boolean.FALSE);
            goodsInfo.setCreateTime(LocalDateTime.now());
            goodsInfo.setCombinedFlag(false);
            goodsInfo.setAddedFlag(0);
            goodsInfo.setCompanyType(BoolFlag.YES);
            goodsInfo.setEnable(3);
            goodsInfo.setDelFlag(DeleteFlag.NO);
        } else {
            //如果已经审核通过，则变更为编辑待审核
            if (GoodsAuditStatus.PASS.equals(oldGoodsInfo.getGoodsAuditStatus())) {
                goodsInfo.setGoodsAuditStatus(GoodsAuditStatus.AUDIT_WAIT_CHECK);
            }
        }

        KsBeanUtil.copyPropertiesIgnoreNull(goodsInfo, oldGoodsInfo);
        return oldGoodsInfo;
    }

    /**
     * 填充sku 规格关联关系
     */
    public GoodsInfoSaleRel handleSkuSaleRel(GoodsInfo goodsInfo, GoodsSaleValue saleValue) {
        GoodsInfoSaleRel goodsInfoSaleRel = new GoodsInfoSaleRel();
        goodsInfoSaleRel.setGoodsId(goodsInfo.getGoodsId());
        goodsInfoSaleRel.setGoodsInfoId(goodsInfo.getGoodsInfoId());
        goodsInfoSaleRel.setSaleId(saleValue.getSaleId());
        goodsInfoSaleRel.setSaleValueId(saleValue.getSaleValueId());
        goodsInfoSaleRel.setSaleName(saleValue.getSaleName());
        goodsInfoSaleRel.setCreateTime(LocalDateTime.now());
        goodsInfoSaleRel.setUpdateTime(LocalDateTime.now());
        goodsInfoSaleRel.setDelFlag(DeleteFlag.NO);
        return goodsInfoSaleRel;
    }

    /**
     * 对比商品字段，检查是否相同
     * @param oldGoods 旧商品数据
     * @param newGoods 新商品数据
     * @return 是否相同，true：相同，false：不同
     */
    public boolean checkGoodsDiffrent(Goods oldGoods, DoudianGoodsPullRecord newGoods) {
        //校验商品名称
        if (!StringUtils.equals(oldGoods.getGoodsName(), newGoods.getName())) {
            return false;
        }
        //校验类目
        //oldGoods.getCateId().equals(newGoods.getCateId());

        //校验商品推荐语
        if (!StringUtils.equals(oldGoods.getGoodsSuggestions(), newGoods.getRecommendRemark())) {
            return false;
        }
        //校验商品主图
        if (!StringUtils.equals(oldGoods.getGoodsImg(), newGoods.getImg())) {
            return false;
        }
        //校验商品详情
        if (!StringUtils.equals(oldGoods.getGoodsDetail(), newGoods.getDescription())) {
            return false;
        }
        //校验商品资质
        String extra = newGoods.getExtra();
        JSONObject extraJson = JSONObject.parseObject(extra);
        JSONArray qualityList = extraJson.getJSONArray("quality_list");
        List<String> newUrls = new ArrayList<>();
        //资质图片
        for (int i = 0; i < qualityList.size(); i++) {
            JSONObject jsonObject = qualityList.getJSONObject(i);
            JSONArray qualityAttachments = jsonObject.getJSONArray("quality_attachments");
            for (int j = 0; j < qualityAttachments.size(); j++) {
                JSONObject jsonObject1 = qualityAttachments.getJSONObject(j);
                String url = jsonObject1.getString("url");
                newUrls.add(url);
            }
        }
        List<GoodImgRelation> relations = goodImgRelationRepository.findByGoodsId(oldGoods.getGoodsId());
        List<String> oldUrls = relations.stream().map(GoodImgRelation::getGoodsQualificationImg).collect(Collectors.toList());
        if (newUrls.size() != oldUrls.size() || !checkDiffrent(oldUrls, newUrls)) {
            return false;
        }

        return true;
    }

    public void failGoodsAgainPull(@RequestBody @Valid DoudianGoodsPullInfoRequest request) {
        log.info("店铺{}失败商品同步start ===========================", request.getShopInfoId());
        //创建线程池
        ExecutorService executorService = doudianGoodsPullPool.myExecutor();
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
        redisService.delete(redisKey);

        //获取失败原因集合，取出分页以及失败id
        List<DoudianPullFailReasonRecord> failReasonList = doudianPullFailReasonRecordService.findByShopInfoId(request.getShopInfoId());

        Integer failAll = failReasonList.stream().mapToInt(DoudianPullFailReasonRecord::getFailCount).sum();

        //失败商品总数
        int total = Optional.ofNullable(failAll).orElse(0);

        //设置计数器，每同步一个减1
        count.set(total);

        //删除上一次拉取的失败原因记录
        doudianPullFailReasonRecordService.deleteByShopInfoId(request.getShopInfoId());

        //统计同步商品总数
        log.info("店铺{}失败商品同步总数：{} -------------- ", request.getShopInfoId(), total);
        redisService.hset(redisKey, DoudianGoodsPullConst.PULL_GOODS_TOTAL_FIELD, String.valueOf(total));

        // 多线程方式
        List<DoudianPullGoodsFailAgainTask> taskList = new ArrayList<>();

        //失败商品重试
        failReasonList.forEach(item -> {
            taskList.add(new DoudianPullGoodsFailAgainTask(
                    this,
                    doudianGoodsPullRecordService,
                    redisService,
                    doudianPullFailReasonRecordService,
                    request,
                    count,
                    item
            ));
        });

        List<Future<Integer>> futures = null;
        try {
            futures = executorService.invokeAll(taskList);
        } catch (InterruptedException e) {
            e.printStackTrace();
        }

    }

    //抖店拉取失败商品重试 任务
    public static class DoudianPullGoodsFailAgainTask implements Callable<Integer> {
        private final DoudianGoodsPullInfoRequest request;
        private final DoudianGoodsPullService doudianGoodsPullService;
        private final DoudianGoodsPullRecordService doudianGoodsPullRecordService;
        private AtomicLong count;
        private final RedisService redisService;
        private final DoudianPullFailReasonRecordService doudianPullFailReasonRecordService;
        private final DoudianPullFailReasonRecord failReasonRecord;

        DoudianPullGoodsFailAgainTask(
                DoudianGoodsPullService doudianGoodsPullService,
                DoudianGoodsPullRecordService doudianGoodsPullRecordService,
                RedisService redisService,
                DoudianPullFailReasonRecordService doudianPullFailReasonRecordService,
                DoudianGoodsPullInfoRequest request,
                AtomicLong count,
                DoudianPullFailReasonRecord failReasonRecord
        ) {
            this.doudianGoodsPullService = doudianGoodsPullService;
            this.doudianGoodsPullRecordService = doudianGoodsPullRecordService;
            this.count = count;
            this.redisService = redisService;
            this.doudianPullFailReasonRecordService = doudianPullFailReasonRecordService;
            this.request = request;
            this.failReasonRecord = failReasonRecord;
        }


        @Override
        public Integer call() {
            String appKey = request.getAppKey();
            String appSecret = request.getAppSecret();
            String accessToken = request.getAccessToken();


            if (FailReasonType.SINGLE_FAIL.equals(failReasonRecord.getFailType())) {
                //单个失败处理
                handleAgain(failReasonRecord.getProductId());
            } else if (FailReasonType.BATCH_FAIL.equals(failReasonRecord.getFailType())) {
                //分页批量失败处理
                Integer failCount = failReasonRecord.getFailCount();
                Integer failPageNum = failReasonRecord.getFailPageNum();
                DouDianGoodsPageNewVO doudianGoodsVo = new DouDianGoodsPageNewVO();
                try {
                    doudianGoodsVo = doudianGoodsPullRecordService.pullDouDianGoodNew(appKey, appSecret, accessToken, failPageNum, failCount);
                } catch (SbcRuntimeException e) {
                    //原子减少失败的数量
                    if (count.addAndGet(-failCount) <= 0) {
                        againFinishStatus();
                    }
                    String failReason = "获取商品分页信息失败";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, failPageNum, failCount, FailReasonType.BATCH_FAIL, e);
                } catch (RetryableException e) {
                    //原子减少失败的数量
                    if (count.addAndGet(-failCount) <= 0) {
                        againFinishStatus();
                    }
                    String failReason = "抖店分页接口超时";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, failPageNum, failCount, FailReasonType.BATCH_FAIL, e);
                } catch (Exception e) {
                    //原子减少失败的数量
                    if (count.addAndGet(-failCount) <= 0) {
                        againFinishStatus();
                    }
                    String failReason = "其他原因";
                    doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), null, failReason, failPageNum, failCount, FailReasonType.BATCH_FAIL, e);
                }
                List<DouDianGoodsNewVO> goodsListData = doudianGoodsVo.getData();
                goodsListData.forEach(item -> {
                    handleAgain(item.getProduct_id());
                });
            }


            return 1;
        }

        public void handleAgain(String productId) {
            try {
                String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();
                //处理商品数据，并且获取详情，保存到mongo
                DoudianGoodsPullRecord record = doudianGoodsPullRecordService.handleSpuData(request, productId);
                doudianGoodsPullRecordService.save(record);

                //保存商品
                doudianGoodsPullRecordService.handleData(request, record);

                //记录成功数
                log.info("店铺{}同步成功:抖店商品id:{} --------------", request.getShopInfoId(), productId);
                redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_SUCCESS_COUNT_FIELD, 1L);
            } catch (IncorrectResultSizeDataAccessException e) {
                String failReason = "保存重复错误";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, null, 1, FailReasonType.SINGLE_FAIL, e);
            } catch (RetryableException e) {
                String failReason = "抖店接口超时";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, null, 1, FailReasonType.SINGLE_FAIL, e);
            } catch (Exception e) {
                String failReason = "商品保存失败";
                doudianGoodsPullService.failReasonHandle(request.getShopInfoId(), productId, failReason, null, 1, FailReasonType.SINGLE_FAIL, e);
            } finally {
                // TODO 所有任务结束后 标志结束
                if (count.decrementAndGet() == 0) {
                    againFinishStatus();
                }
            }
        }

        public void againFinishStatus() {
            String pullStatusKey = DoudianGoodsPullConst.PULL_STATUS_KEY + request.getShopInfoId();
            redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_FAIL_AGAIN_START_FIELD, "0");
            redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_FAIL_AGAIN_FINISH_FIELD, "1");
            redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_FINISH_FIELD, "1");
            log.info("店铺{}失败商品同步end  ===========================", request.getShopInfoId());
        }
    }
}


```



##### 处理Service

```java
package com.wanmi.sbc.goods.doudiangoodspullrecord.service;

import com.alibaba.fastjson.JSONArray;
import com.alibaba.fastjson.JSONObject;
import com.wanmi.sbc.common.base.BaseResponse;
import com.wanmi.sbc.common.enums.*;
import com.wanmi.sbc.common.exception.SbcRuntimeException;
import com.wanmi.sbc.common.util.CodeUtils;
import com.wanmi.sbc.common.util.Constants;
import com.wanmi.sbc.common.util.KsBeanUtil;
import com.wanmi.sbc.customer.bean.vo.StoreVO;
import com.wanmi.sbc.doudian.api.provider.goods.DouDianGoodsProvider;
import com.wanmi.sbc.doudian.api.request.goods.DouDianGoodsDetailRequest;
import com.wanmi.sbc.doudian.api.request.goods.DouDianGoodsListNewRequest;
import com.wanmi.sbc.doudian.api.request.goods.DouDianGoodsListRequest;
import com.wanmi.sbc.doudian.api.request.goods.DouDianSkuListRequest;
import com.wanmi.sbc.doudian.api.response.goods.DouDianGoodsListNewResponse;
import com.wanmi.sbc.doudian.api.response.goods.DouDianGoodsListResponse;
import com.wanmi.sbc.doudian.bean.vo.*;
import com.wanmi.sbc.goods.api.constant.DoudianGoodsPullConst;
import com.wanmi.sbc.goods.api.constant.DoudianGoodsPullErrorCode;
import com.wanmi.sbc.goods.api.constant.GoodsErrorCode;
import com.wanmi.sbc.goods.api.request.doudiangoodspull.DoudianGoodsPullInfoRequest;
import com.wanmi.sbc.goods.bean.enums.CheckStatus;
import com.wanmi.sbc.goods.bean.enums.GoodsAuditStatus;
import com.wanmi.sbc.goods.brand.model.root.ContractBrand;
import com.wanmi.sbc.goods.brand.model.root.GoodsBrand;
import com.wanmi.sbc.goods.brand.repository.ContractBrandRepository;
import com.wanmi.sbc.goods.brand.repository.GoodsBrandRepository;
import com.wanmi.sbc.goods.doudiangoods.model.root.DoudianGoods;
import com.wanmi.sbc.goods.doudiangoods.repository.DoudianGoodsRepository;
import com.wanmi.sbc.goods.doudiangoodsinfo.model.root.DoudianGoodsInfo;
import com.wanmi.sbc.goods.doudiangoodsinfo.repository.DoudianGoodsInfoRepository;
import com.wanmi.sbc.goods.doudiangoodspullrecord.respository.DoudianGoodsPullRecordRepository;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianGoodsCategoryDetailRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianGoodsPullRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianSkuPullRecord;
import com.wanmi.sbc.goods.goodimgrelation.model.root.GoodImgRelation;
import com.wanmi.sbc.goods.goodimgrelation.repository.GoodImgRelationRepository;
import com.wanmi.sbc.goods.goodsinfosalerel.model.root.GoodsInfoSaleRel;
import com.wanmi.sbc.goods.goodsinfosalerel.service.GoodsInfoSaleRelService;
import com.wanmi.sbc.goods.goodsproperty.model.root.GoodsProperty;
import com.wanmi.sbc.goods.goodsproperty.service.GoodsPropertyService;
import com.wanmi.sbc.goods.goodsproprelation.model.root.GoodsPropRelation;
import com.wanmi.sbc.goods.goodsproprelation.service.GoodsPropRelationService;
import com.wanmi.sbc.goods.goodssale.model.root.GoodsSale;
import com.wanmi.sbc.goods.goodssale.service.GoodsSaleService;
import com.wanmi.sbc.goods.goodssalerel.model.root.GoodsSaleRel;
import com.wanmi.sbc.goods.goodssalerel.service.GoodsSaleRelService;
import com.wanmi.sbc.goods.goodssalevalue.model.root.GoodsSaleValue;
import com.wanmi.sbc.goods.goodssalevalue.service.GoodsSaleValueService;
import com.wanmi.sbc.goods.goodsspurecord.modal.root.GoodsInfoRecord;
import com.wanmi.sbc.goods.goodsspurecord.modal.root.GoodsRecord;
import com.wanmi.sbc.goods.goodsspurecord.service.GoodsInfoRecordService;
import com.wanmi.sbc.goods.goodsspurecord.service.GoodsRecordService;
import com.wanmi.sbc.goods.images.GoodsImage;
import com.wanmi.sbc.goods.images.GoodsImageRepository;
import com.wanmi.sbc.goods.info.model.entity.MGoodsInfo;
import com.wanmi.sbc.goods.info.model.root.Goods;
import com.wanmi.sbc.goods.info.model.root.GoodsInfo;
import com.wanmi.sbc.goods.info.repository.GoodsInfoRepository;
import com.wanmi.sbc.goods.info.repository.GoodsRepository;
import com.wanmi.sbc.goods.info.repository.MGoodsInfoRepository;
import com.wanmi.sbc.goods.info.service.GoodsInfoService;
import com.wanmi.sbc.goods.info.service.GoodsService;
import com.wanmi.sbc.goods.providergoodsbrand.model.root.ProviderGoodsBrand;
import com.wanmi.sbc.goods.providergoodsbrand.service.ProviderGoodsBrandService;
import com.wanmi.sbc.goods.redis.RedisService;
import com.wanmi.sbc.goods.standard.model.root.StandardGoods;
import com.wanmi.sbc.goods.standard.model.root.StandardSku;
import com.wanmi.sbc.goods.standard.repository.StandardGoodsRepository;
import com.wanmi.sbc.goods.standard.repository.StandardSkuRepository;
import com.wanmi.sbc.goods.standard.request.StandardSkuQueryRequest;
import com.wanmi.sbc.goods.standardgoodimgrelation.model.root.StandardGoodImgRelation;
import com.wanmi.sbc.goods.standardgoodimgrelation.service.StandardGoodImgRelationService;
import com.wanmi.sbc.goods.standardgoodsproprelation.model.root.StandardGoodsPropRelation;
import com.wanmi.sbc.goods.standardgoodsproprelation.service.StandardGoodsPropRelationService;
import com.wanmi.sbc.goods.standardgoodssalerel.model.root.StandardGoodsSaleRel;
import com.wanmi.sbc.goods.standardgoodssalerel.service.StandardGoodsSaleRelService;
import com.wanmi.sbc.goods.standardimages.model.root.StandardImage;
import com.wanmi.sbc.goods.standardimages.repository.StandardImageRepository;
import com.wanmi.sbc.goods.standardskusalerel.model.root.StandardSkuSaleRel;
import com.wanmi.sbc.goods.standardskusalerel.repository.StandardSkuSaleRelRepository;
import com.wanmi.sbc.setting.api.provider.qualification.QualificationManagementQueryProvider;
import com.wanmi.sbc.setting.api.provider.qualification.QualificationManagementSaveProvider;
import com.wanmi.sbc.setting.api.request.qualification.*;
import com.wanmi.sbc.setting.api.response.qualification.QualificationManagementGetByIdResponse;
import com.wanmi.sbc.setting.bean.dto.QualificationManagementDTO;
import com.wanmi.sbc.setting.bean.enums.QualificationChangeType;
import com.wanmi.sbc.setting.bean.enums.QualificationStatus;
import com.wanmi.sbc.setting.bean.vo.QualificationManagementVO;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.StringUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;
import org.springframework.util.ObjectUtils;

import javax.annotation.Resource;
import java.math.BigDecimal;
import java.time.LocalDateTime;
import java.util.*;
import java.util.stream.Collectors;
import java.util.stream.Stream;

/**
 * @Author liuwei
 */
@Slf4j
@Service
public class DoudianGoodsPullRecordService {

    @Resource
    private DoudianGoodsPullRecordRepository doudianGoodsPullRecordRepository;

    @Autowired
    private DouDianGoodsProvider douDianGoodsProvider;

    @Autowired
    private DoudianGoodsPullRecordService doudianGoodsPullRecordService;

    @Autowired
    private DoudianSkuPullRecordService doudianSkuPullRecordService;

    @Autowired
    private DoudianGoodsRepository doudianGoodsRepository;

    @Autowired
    private DoudianGoodsInfoRepository doudianGoodsInfoRepository;

    @Autowired
    private GoodsRepository goodsRepository;

    @Autowired
    private GoodsInfoRepository goodsInfoRepository;

    @Autowired
    private GoodsService goodsService;

    @Autowired
    private GoodsInfoService goodsInfoService;

    @Autowired
    private GoodsRecordService goodsRecordService;

    @Autowired
    private GoodsImageRepository goodsImageRepository;

    @Autowired
    private GoodsSaleService goodsSaleService;

    @Autowired
    private GoodsSaleValueService goodsSaleValueService;

    @Autowired
    private GoodsSaleRelService goodsSaleRelService;

    @Autowired
    private GoodsPropertyService goodsPropertyService;

    @Autowired
    private GoodsPropRelationService goodsPropRelationService;

    @Autowired
    private GoodsInfoSaleRelService goodsInfoSaleRelService;

    @Autowired
    private RedisService redisService;

    @Autowired
    private QualificationManagementSaveProvider qualificationManagementSaveProvider;

    @Autowired
    private QualificationManagementQueryProvider qualificationManagementQueryProvider;

    @Autowired
    private ProviderGoodsBrandService providerGoodsBrandService;

    @Autowired
    private GoodImgRelationRepository goodImgRelationRepository;

    @Autowired
    private GoodsBrandRepository goodsBrandRepository;

    @Autowired
    private ContractBrandRepository contractBrandRepository;

    @Autowired
    private StandardGoodsRepository standardGoodsRepository;

    @Autowired
    private StandardGoodsSaleRelService standardGoodsSaleRelService;

    @Autowired
    private StandardGoodImgRelationService standardGoodImgRelationService;

    @Autowired
    private StandardGoodsPropRelationService standardGoodsPropRelationService;

    @Autowired
    private StandardSkuRepository standardSkuRepository;

    @Autowired
    private MGoodsInfoRepository mGoodsInfoRepository;

    @Autowired
    private GoodsInfoRecordService goodsInfoRecordService;

    @Autowired
    private StandardImageRepository standardImageRepository;

    @Autowired
    private StandardSkuSaleRelRepository standardSkuSaleRelRepository;


    public static final String LINK_HEAD = "https://sf3-ttcdn-tos.pstatp.com/obj/";

    //默认资质图片 QualificationImg
    public static final String QUALIFICA_IMG_LINK = "https://xingye-online.oss-cn-beijing.aliyuncs.com/a9f4d207de53215087eb3c09776cb7f5.png";

    public void save(DoudianGoodsPullRecord entity) {
        doudianGoodsPullRecordRepository.save(entity);
    }

    public void saveAll(List<DoudianGoodsPullRecord> doudianGoodsPullRecords) {
        doudianGoodsPullRecordRepository.saveAll(doudianGoodsPullRecords);
    }

    public DoudianGoodsPullRecord getById(String goodsId) {
        DoudianGoodsPullRecord goodsRecord = doudianGoodsPullRecordRepository.findById(goodsId).orElse(null);
        if (Objects.isNull(goodsRecord)) {
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.GOODS_NOT_EXIST);
        }
        return goodsRecord;
    }

    /**
     * 同步抖店商品
     *
     * @author liuwei
     */
    /*
    public void pullDoudianGoods(DoudianGoodsPullInfoRequest request) {
        String appKey = request.getAppKey();
        String appSecret = request.getAppSecret();
        StoreVO storeVO = request.getStoreVO();
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();

        log.info("=========================== 抖店商品同步start ===========================");
        redisService.delete(redisKey);
        //创建线程池
        ExecutorService executor = doudianGoodsPullPool.myExecutor();
        //第一次查询分页
        DouDianGoodsPageVO pageVO = this.pullDouDianGood(appKey, appSecret, 0);
        //统计同步商品总数
        log.info("商品同步总数：{} -------------- ", pageVO.getAll());
        redisService.hset(redisKey, DoudianGoodsPullConst.PULL_GOODS_TOTAL_FIELD, pageVO.getAll());
        log.info("商品同步分页数：{} -------------- ", pageVO.getAll_pages());
        redisService.hset(redisKey, DoudianGoodsPullConst.PULL_ALL_PAGES_FIELD, pageVO.getAll_pages());

        //处理数据
        List<DoudianGoodsPullRecord> goodsPullRecordList = this.handleSpuData(pageVO.getData());
        this.handleData(request, executor, goodsPullRecordList, storeVO);

        int pageNum = Integer.parseInt(pageVO.getAll_pages());
        //循环获取抖店商品
        for (int i = 1; i < pageNum; i++) {
            //从第二页开始查询分页
            DouDianGoodsPageVO doudianGoodsVo = this.pullDouDianGood(appKey, appSecret, i);
            List<DouDianGoodsVO> goodsListData = doudianGoodsVo.getData();

            //批量保存填充抖店SPU信息
            log.info("批量保存SPU信息到mongo -------------- ");
            List<DoudianGoodsPullRecord> goodsPullRecords = this.handleSpuData(goodsListData);
            this.handleData(request, executor, goodsPullRecords, storeVO);
            log.info("=========================== 抖店商品同步end ===========================");
        }
    }
    */
    public static void main(String[] args) {
        String data = "{\"功能\":\"按摩\",\"品牌\":\"Jago/佳奥\",\"填充物种类\":\"大豆纤维\",\"成分含量\":\"21%(含)-40%(含)\",\"面料材质\":\"亚麻\"}";
        data = "{}";
//        System.out.println(
    }

    /**
     * 将拉取的商品信息进行处理
     *
     * @param request
     */
    @Transactional(value = "JpaTransactionManager", rollbackFor = Exception.class)
    public void handleData(DoudianGoodsPullInfoRequest request, DoudianGoodsPullRecord goodsPullRecord) {
        String appKey = request.getAppKey();
        String appSecret = request.getAppSecret();
        String accessToken = request.getAccessToken();
        String shopName = request.getShopName();
        String productId = goodsPullRecord.getProductId();
        StoreVO storeVO = request.getStoreVO();
        String redisKey = DoudianGoodsPullConst.DOUDIAN_GOODS_PULL_KEY + request.getShopInfoId();

        /*DouDianGoodsDetailVO douDianGoodsDetailVO = this.pullDoudianDetail(appKey, appSecret, productId);
        DouDianGoodsDetailDataVO spuDetailData = douDianGoodsDetailVO.getData();

        //模拟详情数据
        //DouDianGoodsDetailDataVO spuDetailData = mockDoudianDetail();
        //spuDetailData.setProduct_id(goodsPullRecord.getProductId());

        //补充SPU详情信息,重新保存
        goodsPullRecord.setPic(spuDetailData.getPic());
        goodsPullRecord.setSpecPics(spuDetailData.getSpec_pics());

        if (StringUtils.isNotEmpty(spuDetailData.getProduct_format())) {
            String replace = spuDetailData.getProduct_format().replace("{", "").replace("}", "")
                    .replace(":", "|").replace("\"", "");
            if (StringUtils.isNotEmpty(replace)) {
                goodsPullRecord.setProductFormat(replace);
            }
        }

        goodsPullRecord.setPresellType(StringUtils.isBlank(spuDetailData.getPresell_type()) ? null : Integer.valueOf(spuDetailData.getPresell_type()));
        goodsPullRecord.setMaximumPerOrder(spuDetailData.getMaximum_per_order());
        goodsPullRecord.setLimitPerBuyer(spuDetailData.getLimit_per_buyer());
        goodsPullRecord.setMinimumPerOrder(spuDetailData.getMinimum_per_order());
        goodsPullRecord.setSpecs(specs);
         */
        List<DouDianSpecDetailVO> specs = goodsPullRecord.getSpecs();

        //更新spu详情
        doudianGoodsPullRecordService.save(goodsPullRecord);

        //获取spu关联的sku列表
        DouDianSkuListVO douDianSkuListVO = this.pullDoudianSkuList(appKey, appSecret, productId, accessToken);

        List<DoudianSkuPullRecord> goodsInfoRecordList = this.handleSkuData(douDianSkuListVO.getData());

        //商品SKU测试数据
        //List<DoudianSkuPullRecord> goodsInfoRecordList = mockDoudianSku(spuDetailData);

        doudianSkuPullRecordService.saveAll(goodsInfoRecordList);

        List<String> picList = Optional.ofNullable(goodsPullRecord.getPic()).orElse(new ArrayList<>());
        //如果已存在，则更新抖店spu信息库,不存在则填充到供应商商品库
        /*
        DoudianGoods doudianGoods = doudianGoodsRepository.findByProductId(productId).orElse(null);
        if (Objects.nonNull(doudianGoods)) {

            DoudianGoods convert = KsBeanUtil.convert(goodsPullRecord, DoudianGoods.class);
            convert.setPic(picList.stream().collect(Collectors.joining("|")));
            convert.setUpdateTime(LocalDateTime.now());
            //填充新类目id
            DoudianGoodsCategoryDetailRecord categoryDetail = goodsPullRecord.getCategoryDetail();
            if (Objects.nonNull(categoryDetail)) {
                convert.setFirstCid(categoryDetail.getFirstCid());
                convert.setSecondCid(categoryDetail.getSecondCid());
                convert.setThirdCid(categoryDetail.getThirdCid());
            }

            KsBeanUtil.copyPropertiesIgnoreNull(convert, doudianGoods);
            doudianGoodsRepository.save(doudianGoods);

            //更新抖店sku信息库
            List<String> skuIds = goodsInfoRecordList.stream().map(DoudianSkuPullRecord::getId).collect(Collectors.toList());
            List<DoudianGoodsInfo> skuList = doudianGoodsInfoRepository.findByIds(skuIds);
            if (CollectionUtils.isNotEmpty(skuList)) {
                ArrayList<DoudianGoodsInfo> updateSkus = new ArrayList<>();
                for (DoudianSkuPullRecord skuPullRecord : goodsInfoRecordList) {
                    for (DoudianGoodsInfo sku : skuList) {
                        if (sku.getId().equals(skuPullRecord.getId())) {
                            KsBeanUtil.copyPropertiesIgnoreNull(skuPullRecord, sku);
                            updateSkus.add(sku);
                        }
                    }
                }
                doudianGoodsInfoRepository.saveAll(updateSkus);
            }

            //更新商品计数
            redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_UPDATE_COUNT_FIELD, 1L);
        } else {
*/
            Long companyInfoId = storeVO.getCompanyInfo().getCompanyInfoId();
            Goods oldGoods = goodsRepository.findByDoudianGoodsIdAndDelFlag(goodsPullRecord.getProductId(), DeleteFlag.NO).orElse(new Goods());
            Goods goods = new Goods();

            goods.setMoreSpecFlag(DefaultFlag.YES.toValue());
            goods.setCompanyType(BoolFlag.YES);
            goods.setGoodsOrigin(DefaultFlag.YES);
            goods.setDoudianGoodsId(goodsPullRecord.getProductId());
            goods.setOriginStoreName(shopName);
            goods.setGoodsName(goodsPullRecord.getName());
            goods.setGoodsImg(goodsPullRecord.getImg());
            goods.setGoodsDetail(goodsPullRecord.getDescription());
            goods.setGoodsSuggestions(goodsPullRecord.getRecommendRemark());
            goods.setLinePrice(goodsPullRecord.getMarketPrice());
            goods.setTiktokSellPrice(goodsPullRecord.getDiscountPrice());
            goods.setPresellType(goodsPullRecord.getPresellType());
            goods.setUpdateTime(LocalDateTime.now());
            goods.setDoudianShopInfoId(request.getShopInfoId());
            goods.setGoodsSource(0);
            goods.setSupplierName(request.getStoreVO().getCompanyInfo().getCompanyName());

            goods.setGoodsAuditStatus(GoodsAuditStatus.PASS);
            goods.setGoodsStatus(1);

            if (Objects.isNull(oldGoods.getCateId()) || oldGoods.getCateId() == 0) {
                //填充默认类目
                goods.setCateId(1975L);
            }

            if (Objects.isNull(oldGoods.getBrandId())) {
                //填充默认品牌
                ProviderGoodsBrand providerBrand = providerGoodsBrandService.getByBrandName("抖店品牌", storeVO.getStoreId());
                if (Objects.nonNull(providerBrand)) {
                    goods.setBrandId(providerBrand.getBrandId());
                }
            }

            final boolean first = Objects.isNull(oldGoods.getGoodsId());
            //第一次拉取，新增字段
            if (Objects.isNull(oldGoods.getGoodsId())) {
                //first = true;

                goods.setGoodsType(DefaultFlag.NO.toValue());
                //goods.setGoodsAuditStatus(GoodsAuditStatus.INITIAL_STATE);
                //goods.setGoodsStatus(3);

                String systemProviderGoodsCode = CodeUtils.getSystemProviderGoodsCode();
                goods.setGoodsNo(systemProviderGoodsCode);

                goods.setSaleType(1);
                goods.setDelFlag(DeleteFlag.NO);
                goods.setAddedFlag(0);
                goods.setStoreId(storeVO.getStoreId());
                goods.setAddedTimingFlag(Boolean.FALSE);
                goods.setCompanyInfoId(companyInfoId);
                goods.setAuditStatus(CheckStatus.WAIT_CHECK);
                goods.setCreateTime(LocalDateTime.now());
            } else {
                //如果不属于审核通过、初始化时，则不修改审核状态
                if (!(GoodsAuditStatus.PASS.equals(oldGoods.getGoodsAuditStatus()) || GoodsAuditStatus.INITIAL_STATE.equals(oldGoods.getGoodsAuditStatus()))) {
                    oldGoods.setGoodsAuditStatus(oldGoods.getGoodsAuditStatus());
                    oldGoods.setGoodsStatus(oldGoods.getGoodsStatus());
                }
            }

            //添加图片
            KsBeanUtil.copyPropertiesIgnoreNull(goods, oldGoods);
            Goods saveGoods = goodsService.add(oldGoods);
            GoodsRecord goodsRecord = KsBeanUtil.convert(saveGoods, GoodsRecord.class);
            if (first) {
                //添加商品图片
                List<GoodsImage> goodsImages = new ArrayList<>();
                if (CollectionUtils.isNotEmpty(picList)) {
                    picList.stream().forEach(img -> {
                        GoodsImage goodsImage = new GoodsImage();
                        goodsImage.setArtworkUrl(img);
                        goodsImage.setGoodsId(saveGoods.getGoodsId());
                        goodsImage.setDelFlag(DeleteFlag.NO);
                        goodsImage.setCreateTime(LocalDateTime.now());
                        goodsImage.setUpdateTime(LocalDateTime.now());
                        goodsImages.add(goodsImage);
                    });
                }
                List<GoodsImage> goodsImages1 = goodsImageRepository.saveAll(goodsImages);
                goodsRecord.setGoodsImages(goodsImages1);
            } else {
                goodsImageRepository.deleteByGoodsId(saveGoods.getGoodsId());
                //添加商品图片
                List<GoodsImage> goodsImages = new ArrayList<>();
                if (CollectionUtils.isNotEmpty(picList)) {
                    picList.stream().forEach(img -> {
                        GoodsImage goodsImage = new GoodsImage();
                        goodsImage.setArtworkUrl(img);
                        goodsImage.setGoodsId(saveGoods.getGoodsId());
                        goodsImage.setDelFlag(DeleteFlag.NO);
                        goodsImage.setCreateTime(LocalDateTime.now());
                        goodsImage.setUpdateTime(LocalDateTime.now());
                        goodsImages.add(goodsImage);
                    });
                }
                List<GoodsImage> goodsImages1 = goodsImageRepository.saveAll(goodsImages);
                goodsRecord.setGoodsImages(goodsImages1);
            }

            //添加规格
            List<GoodsSaleRel> saleRelList = new ArrayList<>();
            List<GoodsSaleValue> saleValueList = new ArrayList<>();
            //如果是更新，则获取旧的规格关联关系
            List<GoodsSaleRel> oldGoodsSaleRels = first ? new ArrayList<>() : goodsSaleRelService.getByGoodsId(saveGoods.getGoodsId());

            Map<String, List<GoodsSaleRel>> oldSaleRels = oldGoodsSaleRels.stream().collect(Collectors.groupingBy(GoodsSaleRel::getSaleTypeName));

            if (CollectionUtils.isNotEmpty(specs)) {
                //先删除旧规格关联
                goodsSaleRelService.deleteByGoodsId(saveGoods.getGoodsId());
                specs.forEach(specInfo -> {
                    if (StringUtils.isBlank(specInfo.getName())) {
                        return;
                    }
                    //根据规格名称获取，不存在则新建
                    GoodsSale sale = goodsSaleService.getSale(specInfo.getName());
                    if (Objects.isNull(sale)) {
                        //新建规格项
                        GoodsSale goodsSale = new GoodsSale();
                        goodsSale.setSaleTypeName(specInfo.getName());
                        goodsSale.setCreateTime(LocalDateTime.now());
                        goodsSale.setUpdateTime(LocalDateTime.now());
                        goodsSale.setDelFlag(DeleteFlag.NO);
                        List<String> saleValueNameList = specInfo.getValues().stream()
                                .filter(v -> StringUtils.isNotBlank(v.getName()))
                                .map(DouDianSpecDetaiValueVO::getName)
                                .collect(Collectors.toList());
                        GoodsSale saveGoodsSale = goodsSaleService.add(goodsSale, saleValueNameList);
                        List<GoodsSaleValue> saveSaleValues = saveGoodsSale.getGoodsSaleValues();
                        saleValueList.addAll(saveSaleValues);

                        //新建关联中间表
                        saveSaleValues.forEach(saveSaleValue -> {
                            GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                            goodsSaleRel.setCreateTime(LocalDateTime.now());
                            goodsSaleRel.setUpdateTime(LocalDateTime.now());
                            goodsSaleRel.setDelFlag(DeleteFlag.NO);
                            goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                            goodsSaleRel.setSaleId(saveGoodsSale.getSaleId());
                            goodsSaleRel.setSaleValueId(saveSaleValue.getSaleValueId());
                            goodsSaleRel.setSaleName(saveGoodsSale.getSaleName());
                            goodsSaleRel.setSaleTypeName(saveGoodsSale.getSaleTypeName());
                            saleRelList.add(goodsSaleRel);
                        });

                    } else {
                        //获取所有过滤的规格值名称
                        List<String> saleValueNameList = specInfo.getValues().stream()
                                .filter(v -> StringUtils.isNotBlank(v.getName()))
                                .map(DouDianSpecDetaiValueVO::getName)
                                .collect(Collectors.toList());
                        saleValueNameList.forEach(saleValueName -> {
                            if (StringUtils.isBlank(saleValueName)) {
                                return;
                            }
                            //校验规格值是否存在
                            List<GoodsSaleValue> forCheck = goodsSaleValueService.findForCheck(sale.getSaleId(), saleValueName);
                            GoodsSaleValue checkSaleValue = forCheck.stream()
                                    .filter(s -> IsBoss.YES.equals(s.getIsBoss()) && s.getSaleName().equals(saleValueName))
                                    .findFirst().orElse(null);

                            if (Objects.isNull(checkSaleValue)) {
                                //规格值没有则新建
                                GoodsSaleValue saleValue = new GoodsSaleValue();
                                saleValue.setCreateTime(LocalDateTime.now());
                                saleValue.setUpdateTime(LocalDateTime.now());
                                saleValue.setDelFlag(DeleteFlag.NO);
                                saleValue.setSaleId(sale.getSaleId());
                                saleValue.setSaleName(saleValueName);
                                saleValue.setIsBoss(IsBoss.NO);
                                saleValue.setStoreId(storeVO.getStoreId());
                                GoodsSaleValue saveSaleValue = goodsSaleValueService.add(saleValue);
                                //为了sku添加规格
                                saleValueList.add(saveSaleValue);
                                //插入中间表
                                GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                                goodsSaleRel.setCreateTime(LocalDateTime.now());
                                goodsSaleRel.setUpdateTime(LocalDateTime.now());
                                goodsSaleRel.setDelFlag(DeleteFlag.NO);
                                goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                                goodsSaleRel.setSaleId(sale.getSaleId());
                                goodsSaleRel.setSaleValueId(saveSaleValue.getSaleValueId());
                                goodsSaleRel.setSaleName(saveSaleValue.getSaleName());
                                goodsSaleRel.setSaleTypeName(sale.getSaleTypeName());
                                saleRelList.add(goodsSaleRel);
                            } else {
                                //为了sku添加规格
                                saleValueList.add(checkSaleValue);
                                //规格值存在，关联中间表
                                GoodsSaleRel goodsSaleRel = new GoodsSaleRel();
                                goodsSaleRel.setCreateTime(LocalDateTime.now());
                                goodsSaleRel.setUpdateTime(LocalDateTime.now());
                                goodsSaleRel.setDelFlag(DeleteFlag.NO);
                                goodsSaleRel.setGoodsId(saveGoods.getGoodsId());
                                goodsSaleRel.setSaleId(sale.getSaleId());
                                goodsSaleRel.setSaleValueId(checkSaleValue.getSaleValueId());
                                goodsSaleRel.setSaleName(checkSaleValue.getSaleName());
                                goodsSaleRel.setSaleTypeName(sale.getSaleTypeName());
                                saleRelList.add(goodsSaleRel);
                            }

                        });
                    }
                });
                goodsSaleRelService.addAll(saleRelList);
            }
            //填充规格到mongo中
            goodsRecord.setGoodsSaleRels(saleRelList);

            //添加商品属性
            List<GoodsPropRelation> propRelationList = new ArrayList<>();
            String productFormat = goodsPullRecord.getProductFormat();
            if (StringUtils.isNotBlank(productFormat)) {
                //去除{}及双引号
                //String replace = goodsPullRecord.getProductFormat().replace("{", "").replace("}", "").replaceAll("\\\"", "");
                String[] values = productFormat.split("\\,");
                for (String v : values) {
                    String[] propertySplit = v.split("\\|");
                    if (propertySplit.length != 2) {
                        continue;
                    }
                    //辅助属性项不存在则新增辅助属性
                    GoodsProperty byPropName = goodsPropertyService.findByPropName(propertySplit[0], 2);
                    if (ObjectUtils.isEmpty(byPropName)) {
                        GoodsProperty goodsProperty = new GoodsProperty();
                        goodsProperty.setRequired(2);
                        goodsProperty.setPropType(2);
                        goodsProperty.setEnable(1);
                        goodsProperty.setPropDetailType(0);
                        goodsProperty.setPropName(propertySplit[0]);
                        goodsProperty.setGoodsPropertyDetail(new ArrayList<>());
                        goodsProperty.setDelFlag(DeleteFlag.NO);
                        goodsProperty.setCreateTime(LocalDateTime.now());
                        goodsProperty.setUpdateTime(LocalDateTime.now());
                        GoodsProperty saveProperty = goodsPropertyService.add(goodsProperty);

                        GoodsPropRelation goodsPropRelation = new GoodsPropRelation();
                        goodsPropRelation.setPropId(saveProperty.getId());
                        goodsPropRelation.setPropValue(propertySplit[1]);
                        goodsPropRelation.setPropDetailType(0);
                        goodsPropRelation.setPropType(2);
                        goodsPropRelation.setCreateTime(LocalDateTime.now());
                        goodsPropRelation.setGoodsId(saveGoods.getGoodsId());
                        GoodsPropRelation propRelation = goodsPropRelationService.add(goodsPropRelation);
                        propRelationList.add(propRelation);
                    } else {
                        //第一次拉取商品是，关联辅助属性值
                        if (!first) {
                            //先删除再做新增
                            goodsPropRelationService.deleteByGoodsId(saveGoods.getGoodsId(), byPropName.getId(), 2, 0);
                        }
                        GoodsPropRelation goodsPropRelation = new GoodsPropRelation();
                        goodsPropRelation.setPropId(byPropName.getId());
                        goodsPropRelation.setPropValue(propertySplit[1]);
                        goodsPropRelation.setPropDetailType(0);
                        goodsPropRelation.setPropType(2);
                        goodsPropRelation.setCreateTime(LocalDateTime.now());
                        goodsPropRelation.setGoodsId(saveGoods.getGoodsId());
                        GoodsPropRelation propRelation = goodsPropRelationService.add(goodsPropRelation);
                        propRelationList.add(propRelation);

                    }
                }

            }
            //属性关联
            goodsRecord.setPropRelationList(propRelationList);


            //平台商品库是否存在
            final boolean standardGoodsFlag = StringUtils.isNotBlank(saveGoods.getStandardGoodsId());
            //保存平台商品
            StandardGoods saveStandardGoods = this.saveStandardGoods(saveGoods);
            saveGoods.setStandardGoodsId(saveStandardGoods.getGoodsId());
            if (first) {
                //增加关联关系和修改供应商表状态
                goodsRepository.updateStandardId(goodsRecord.getGoodsId(), saveStandardGoods.getGoodsId(), 1, GoodsAuditStatus.PASS);
            }

            String extra = goodsPullRecord.getExtra();
            //保存资质图片
            List<GoodImgRelation> goodImgRelationList = saveQualification(request, saveGoods, extra, first);
            goodsRecord.setGoodImgRelations(goodImgRelationList);

            //保存平台商品相关关联
            this.saveStandardRel(goodsRecord, saveStandardGoods);
            //保存mongo数据
            goodsRecord.setUpdateTime(LocalDateTime.now());
            goodsRecordService.save(goodsRecord);

            //sku落供应商库
            List<GoodsInfo> goodsInfoList = new ArrayList<>();
            goodsInfoRecordList.forEach(item -> {
                GoodsInfo oldGoodsInfo = goodsInfoRepository.findByDoudianSkuIdAndDelFlag(item.getId(), DeleteFlag.NO).orElse(new GoodsInfo());
                GoodsInfo goodsInfo = new GoodsInfo();
                goodsInfo.setDoudianSpuId(goodsPullRecord.getProductId());
                goodsInfo.setDoudianSkuId(item.getId());
                goodsInfo.setDoudianSkuPrice(item.getPrice());
                goodsInfo.setOutSkuNo(item.getId());
                goodsInfo.setGoodsInfoName(goodsPullRecord.getName());
                goodsInfo.setGoodsId(saveGoods.getGoodsId());
                goodsInfo.setUpdateTime(LocalDateTime.now());

                goodsInfo.setCateId(saveGoods.getCateId());
                goodsInfo.setBrandId(saveGoods.getBrandId());

                //填充goodsInfo表关联skuId 并变更审核状态
                goodsInfo.setBossGoodsInfoId(null);
                goodsInfo.setGoodsAuditStatus(GoodsAuditStatus.PASS);
                goodsInfo.setEnable(1);

                //是否新增sku
                if (Objects.isNull(oldGoodsInfo.getGoodsInfoId())) {
                    goodsInfo.setUnitValueId(59L);
                    //goodsInfo.setGoodsAuditStatus(GoodsAuditStatus.INITIAL_STATE);
                    goodsInfo.setGoodsInfoNo(CodeUtils.getSystemProviderSkuGoodsCode());
                    goodsInfo.setCompanyInfoId(companyInfoId);
                    goodsInfo.setStoreId(storeVO.getStoreId());
                    goodsInfo.setAuditStatus(CheckStatus.WAIT_CHECK);
                    goodsInfo.setAddedTimingFlag(Boolean.FALSE);
                    goodsInfo.setAloneFlag(Boolean.FALSE);
                    goodsInfo.setCreateTime(LocalDateTime.now());
                    goodsInfo.setCombinedFlag(false);
                    goodsInfo.setAddedFlag(0);
                    goodsInfo.setCompanyType(BoolFlag.YES);
                    //goodsInfo.setEnable(3);
                    goodsInfo.setDelFlag(DeleteFlag.NO);
                } else {
                    //如果不属于审核通过、初始化时，则不修改审核状态
                    if (!(GoodsAuditStatus.PASS.equals(oldGoodsInfo.getGoodsAuditStatus()) || GoodsAuditStatus.INITIAL_STATE.equals(oldGoodsInfo.getGoodsAuditStatus()))) {
                        goodsInfo.setGoodsAuditStatus(oldGoodsInfo.getGoodsAuditStatus());
                        goodsInfo.setEnable(goodsInfo.getEnable());
                    }
                }

                KsBeanUtil.copyPropertiesIgnoreNull(goodsInfo, oldGoodsInfo);
                goodsInfoList.add(oldGoodsInfo);
            });

            //如果sku不是新增，则删除旧规格关联关系
            List<String> goodsInfos = goodsInfoList.stream().map(GoodsInfo::getGoodsInfoId).collect(Collectors.toList());
            if (CollectionUtils.isNotEmpty(goodsInfos)) {
                goodsInfoSaleRelService.deleteByGoodsInfoIds(goodsInfos, saveGoods.getGoodsId());
                goodsImageRepository.deleteByGoodsInfoIds(goodsInfos);
            }

            List<GoodsInfo> saveGoodsInfos = goodsInfoService.batchSave(goodsInfoList);
            List<SpecPicVO> specPics = goodsPullRecord.getSpecPics();
            List<GoodsImage> goodsInfoImageList = new ArrayList<>();
            List<GoodsInfoSaleRel> goodsInfoSaleRelList = new ArrayList<>();
            Map<String, GoodsInfo> saveSkuMap = saveGoodsInfos.stream().collect(Collectors.toMap(GoodsInfo::getDoudianSkuId, g -> g));
            goodsInfoRecordList.forEach(item -> {
                GoodsInfo goodsInfo = saveSkuMap.get(item.getId());
                //sku图片
                if (CollectionUtils.isNotEmpty(specPics)) {
                    List<SpecPicVO> specPicVOS = specPics.stream()
                            .filter(specPic ->
                                    StringUtils.equalsAny(specPic.getSpec_detail_id(), item.getSpecDetailId1(), item.getSpecDetailId2(), item.getSpecDetailId3())).collect(Collectors.toList());
                    //如果不存在规格图片，则默认存储商品主图
                    if (CollectionUtils.isNotEmpty(specPicVOS)) {
                        specPicVOS.forEach(specPic -> {
                            GoodsImage goodsImage = new GoodsImage();
                            goodsImage.setGoodsInfoId(goodsInfo.getGoodsInfoId());
                            goodsImage.setDelFlag(DeleteFlag.NO);
                            String artworkUrl = LINK_HEAD + specPic.getPic();
                            goodsImage.setArtworkUrl(artworkUrl);
                            goodsImage.setCreateTime(LocalDateTime.now());
                            goodsImage.setUpdateTime(LocalDateTime.now());
                            goodsInfoImageList.add(goodsImage);
                            goodsInfoRepository.updateGoodsInfoImg(goodsInfo.getGoodsInfoId(), artworkUrl);
                        });
                    } else {
                        //如果不存在规格图片，则默认存储商品主图
                        GoodsImage goodsImage = new GoodsImage();
                        goodsImage.setGoodsInfoId(goodsInfo.getGoodsInfoId());
                        goodsImage.setDelFlag(DeleteFlag.NO);
                        goodsImage.setArtworkUrl(saveGoods.getGoodsImg());
                        goodsImage.setCreateTime(LocalDateTime.now());
                        goodsImage.setUpdateTime(LocalDateTime.now());
                        goodsInfoImageList.add(goodsImage);
                        goodsInfoRepository.updateGoodsInfoImg(goodsInfo.getGoodsInfoId(), saveGoods.getGoodsImg());
                    }
                } else {
                    //如果不存在规格图片，则默认存储商品主图
                    GoodsImage goodsImage = new GoodsImage();
                    goodsImage.setGoodsInfoId(goodsInfo.getGoodsInfoId());
                    goodsImage.setDelFlag(DeleteFlag.NO);
                    goodsImage.setArtworkUrl(saveGoods.getGoodsImg());
                    goodsImage.setCreateTime(LocalDateTime.now());
                    goodsImage.setUpdateTime(LocalDateTime.now());
                    goodsInfoImageList.add(goodsImage);
                    goodsInfoRepository.updateGoodsInfoImg(goodsInfo.getGoodsInfoId(), saveGoods.getGoodsImg());
                }

                //sku规格关联
                saleValueList.forEach(saleValue -> {
                    if (StringUtils.isNotBlank(item.getSpecDetailName1()) && saleValue.getSaleName().equals(item.getSpecDetailName1())) {
                        //插入中间表
                        goodsInfoSaleRelList.add(saleRelHandle(goodsInfo, saleValue));
                    }

                    if (StringUtils.isNotBlank(item.getSpecDetailName2()) && saleValue.getSaleName().equals(item.getSpecDetailName2())) {
                        //插入中间表
                        goodsInfoSaleRelList.add(saleRelHandle(goodsInfo, saleValue));
                    }

                    if (StringUtils.isNotBlank(item.getSpecDetailName3()) && saleValue.getSaleName().equals(item.getSpecDetailName3())) {
                        //插入中间表
                        goodsInfoSaleRelList.add(saleRelHandle(goodsInfo, saleValue));
                    }
                });
            });
            goodsInfoSaleRelService.batchSave(goodsInfoSaleRelList);
            //保存sku图片
            goodsImageRepository.saveAll(goodsInfoImageList);

            List<MGoodsInfo> mGoodsInfos = KsBeanUtil.convert(saveGoodsInfos, MGoodsInfo.class);
            List<GoodsInfoRecord> goodsInfoRecords = KsBeanUtil.convert(saveGoodsInfos, GoodsInfoRecord.class);
            mGoodsInfoRepository.saveAll(mGoodsInfos);
            goodsInfoRecordService.saveAll(goodsInfoRecords);

            //更新平台商品库SKU
            Map<String, List<GoodsImage>> skuImgsMap = goodsInfoImageList.stream().collect(Collectors.groupingBy(GoodsImage::getGoodsInfoId));

            //保存平台SKU数据
            this.saveStandardSku(saveGoods, saveGoodsInfos, goodsInfoSaleRelList, skuImgsMap);


            //等商品流程完成，新增及更新计数
            if (first) {
                //新增商品计数
                redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_ADD_COUNT_FIELD, 1L);
            } else {
                //更新商品计数
                redisService.hincr(redisKey, DoudianGoodsPullConst.PULL_UPDATE_COUNT_FIELD, 1L);
            }
        //}
    }

    //保存平台SKU数据、相关关联关系
    public void saveStandardSku(Goods saveGoods, List<GoodsInfo> saveGoodsInfos, List<GoodsInfoSaleRel> goodsInfoSaleRelList, Map<String, List<GoodsImage>> skuImgsMap) {
        String standardGoodsId = saveGoods.getStandardGoodsId();
        standardSkuRepository.deleteByGoodsId(standardGoodsId);
        List<StandardSku> oldStandardSkus = standardSkuRepository.findByGoodsId(standardGoodsId);
        //根据外部skuId分组成Map
        Map<String, List<StandardSku>> oldStandardSkuMap = oldStandardSkus.stream().collect(Collectors.groupingBy(StandardSku::getOutSkuNo));
        //过滤出已经删除的SKU
        List<StandardSku> oldDeleteSkus = oldStandardSkus.stream()
                .filter(item -> !saveGoodsInfos.stream().map(GoodsInfo::getDoudianSkuId).collect(Collectors.toList()).contains(item.getOutSkuNo()))
                .collect(Collectors.toList());
        if (CollectionUtils.isNotEmpty(oldDeleteSkus)) {
            List<String> delSkuIds = oldDeleteSkus.stream().map(StandardSku::getGoodsInfoId).collect(Collectors.toList());
            standardSkuRepository.deleteByGoodsInfoIds(delSkuIds);
            standardImageRepository.deleteByGoodsInfoIds(delSkuIds);
            standardSkuSaleRelRepository.deleteByGoodsInfoIds(delSkuIds, standardGoodsId);
        }
        saveGoodsInfos.forEach(goodsInfo -> {
            //获取该sku的图片
            List<GoodsImage> goodsImages = skuImgsMap.get(goodsInfo.getGoodsInfoId());

            StandardSku standardSku = new StandardSku();
            KsBeanUtil.copyPropertiesIgnoreNull(goodsInfo, standardSku);

            standardSku.setProviderGoodsInfoId(goodsInfo.getGoodsInfoId());
            standardSku.setGoodsId(standardGoodsId);
            standardSku.setGoodsWeight(goodsInfo.getGoodsInfoWeight());
            standardSku.setGoodsCubage(goodsInfo.getGoodsInfoCubage());
            standardSku.setEnable(1);
            standardSku.setGoodsInfoId(null);
            if (CollectionUtils.isNotEmpty(goodsImages) && Objects.nonNull(goodsImages.get(0))) {
                standardSku.setGoodsInfoImg(goodsImages.get(0).getArtworkUrl());
            }

            List<StandardSku> oldSkus = oldStandardSkuMap.get(goodsInfo.getDoudianSkuId());
            StandardSku oldStandardSku = new StandardSku();
            final boolean isUpdate = CollectionUtils.isNotEmpty(oldSkus);
            if (isUpdate) {
                oldStandardSku = oldSkus.get(0);
                standardSku.setGoodsInfoId(oldStandardSku.getGoodsInfoId());
            } else {
                String standardSkuCode = CodeUtils.getStandardSkuCode();
                standardSku.setGoodsInfoNo(standardSkuCode);
            }

            KsBeanUtil.copyPropertiesIgnoreNull(standardSku, oldStandardSku);
            StandardSku saveStandardSku = standardSkuRepository.save(oldStandardSku);

            //更新供应商SKU关联关系
            goodsInfoRepository.updateBossGoodsInfoId(goodsInfo.getGoodsInfoId(), saveStandardSku.getGoodsInfoId());

            List<GoodsInfoSaleRel> skuSaleRelList = new ArrayList<>();
            List<GoodsImage> skuImgList = new ArrayList<>();
            //如果是更新，则校验是否已做修改，新增则不做校验
            if (isUpdate) {
                List<StandardSkuSaleRel> oldSkuSaleRels = standardSkuSaleRelRepository.findByStandardGoodsInfoIdAndDelFlag(saveStandardSku.getGoodsInfoId(), DeleteFlag.NO);
                //过滤出删除的规格
                List<StandardSkuSaleRel> oldSkuSale = oldSkuSaleRels.stream()
                        .filter(item -> !goodsInfoSaleRelList.stream().map(GoodsInfoSaleRel::getSaleName).collect(Collectors.toList()).contains(item.getSaleName()))
                        .collect(Collectors.toList());
                //删除掉已经删除的规格关联关系
                if (CollectionUtils.isNotEmpty(oldSkuSale)) {
                    List<Long> deleteSaleId = oldSkuSale.stream().map(StandardSkuSaleRel::getSaleRelId).collect(Collectors.toList());
                    standardSkuSaleRelRepository.deleteByIdList(deleteSaleId);
                }
                //过滤出新增的，进行新增
                skuSaleRelList = goodsInfoSaleRelList.stream()
                        .filter(item -> !oldSkuSaleRels.stream().map(StandardSkuSaleRel::getSaleName).collect(Collectors.toList()).contains(item.getSaleName()))
                        .collect(Collectors.toList());


                //过滤出已经删除的图片
                List<StandardImage> oldImages = standardImageRepository.findByGoodsInfoId(saveStandardSku.getGoodsInfoId());
                List<StandardImage> oldDeleteImgs = oldImages.stream()
                        .filter(item -> !goodsImages.stream().map(GoodsImage::getArtworkUrl).collect(Collectors.toList()).contains(item.getArtworkUrl()))
                        .collect(Collectors.toList());
                if (CollectionUtils.isNotEmpty(oldDeleteImgs)) {
                    List<Long> deleteImgIds = oldDeleteImgs.stream().map(StandardImage::getImageId).collect(Collectors.toList());
                    standardImageRepository.deleteByIds(deleteImgIds);
                }
                //过滤出新增的图片
                skuImgList = goodsImages.stream()
                        .filter(item -> !oldImages.stream().map(StandardImage::getArtworkUrl).collect(Collectors.toList()).contains(item.getArtworkUrl()))
                        .collect(Collectors.toList());

            } else {
                skuSaleRelList = goodsInfoSaleRelList;
                skuImgList = goodsImages;
            }


            //保存sku图片
            skuImgList.forEach(s -> {
                StandardImage standardImage = new StandardImage();
                standardImage.setDelFlag(DeleteFlag.NO);
                standardImage.setCreateTime(LocalDateTime.now());
                standardImage.setGoodsInfoId(saveStandardSku.getGoodsInfoId());
                standardImage.setArtworkUrl(s.getArtworkUrl());
                standardImageRepository.save(standardImage);
            });

            //匹配供应商sku 规格
            skuSaleRelList.forEach(goodsInfoSaleRelVO -> {
                //添加平台新增sku规格关联关系
                StandardSkuSaleRel standardSkuSaleRel = new StandardSkuSaleRel();
                standardSkuSaleRel.setDelFlag(DeleteFlag.NO);
                standardSkuSaleRel.setCreateTime(LocalDateTime.now());
                standardSkuSaleRel.setSaleId(goodsInfoSaleRelVO.getSaleId());
                standardSkuSaleRel.setSaleValueId(goodsInfoSaleRelVO.getSaleValueId());
                standardSkuSaleRel.setSaleName(goodsInfoSaleRelVO.getSaleName());
                standardSkuSaleRel.setSaleValueName(goodsInfoSaleRelVO.getSaleValueName());
                standardSkuSaleRel.setStandardGoodsInfoId(saveStandardSku.getGoodsInfoId());
                standardSkuSaleRel.setStandardGoodsId(saveStandardSku.getGoodsId());
                standardSkuSaleRelRepository.save(standardSkuSaleRel);
            });
        });
    }

    /**
     * 填充sku 规格关联关系
     *
     * @param goodsInfo
     * @param saleValue
     * @return
     */
    public GoodsInfoSaleRel saleRelHandle(GoodsInfo goodsInfo, GoodsSaleValue saleValue) {
        GoodsInfoSaleRel goodsInfoSaleRel = new GoodsInfoSaleRel();
        goodsInfoSaleRel.setGoodsId(goodsInfo.getGoodsId());
        goodsInfoSaleRel.setGoodsInfoId(goodsInfo.getGoodsInfoId());
        goodsInfoSaleRel.setSaleId(saleValue.getSaleId());
        goodsInfoSaleRel.setSaleValueId(saleValue.getSaleValueId());
        goodsInfoSaleRel.setSaleName(saleValue.getSaleName());
        goodsInfoSaleRel.setCreateTime(LocalDateTime.now());
        goodsInfoSaleRel.setUpdateTime(LocalDateTime.now());
        goodsInfoSaleRel.setDelFlag(DeleteFlag.NO);
        return goodsInfoSaleRel;
    }


    /**
     * 拉取抖店商品
     */
    public DouDianGoodsPageVO pullDouDianGood(String appKey, String appSecret, int pageNum, int pageSize, String accessToken) {
        DouDianGoodsListResponse context = douDianGoodsProvider.pageGoods(DouDianGoodsListRequest
                .builder()
                .app_key(appKey)
                .app_secret(appSecret)
                .access_token(accessToken)
                .page(String.valueOf(pageNum))
                .size(String.valueOf(pageSize))
                .status("0")
                .build()).getContext();
        if (context.getErr_no() != 0) {
            log.error("================= 错误码:{}", context.getErr_no());
            log.error("================= 获取抖店分页信息失败:message:{}", context.getMessage());
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.PULL_GOODS_PAGE_FAIL);
        }
        return context.getData();
    }


    /**
     * 拉取抖店商品 - 新
     */
    public DouDianGoodsPageNewVO pullDouDianGoodNew(String appKey, String appSecret, String accessToken, int pageNum, int pageSize) {
        DouDianGoodsListNewResponse context = douDianGoodsProvider.pageGoodsNew(DouDianGoodsListNewRequest
                .builder()
                .appKey(appKey)
                .appSecret(appSecret)
                .accessToken(accessToken)
                .page(String.valueOf(pageNum))
                .size(String.valueOf(pageSize))
                .status("0")
                .build()).getContext();
        if (context.getErr_no() != 0) {
            log.error("================= 错误码:{}", context.getErr_no());
            log.error("================= 获取抖店分页信息失败:message:{}", context.getMessage());
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.PULL_GOODS_PAGE_FAIL);
        }
        return context.getData();
    }

    /**
     * 获取抖店SPU详情信息
     *
     * @param appKey
     * @param appSecret
     * @param productId
     * @return
     */
    public DouDianGoodsDetailVO pullDoudianDetail(String appKey, String appSecret, String productId, String accessToken) {
        //根据id获取SPU详情
        DouDianGoodsDetailVO douDianGoodsDetailVO = douDianGoodsProvider.getGoodsDetail(DouDianGoodsDetailRequest
                .builder().product_id(productId)
                .app_key(appKey)
                .app_secret(appSecret)
                .access_token(accessToken)
                .build()).getContext().getDouDianGoodsDetailVO();

        if (douDianGoodsDetailVO.getErr_no() != 0) {
            log.error("================= 错误码:{}", douDianGoodsDetailVO.getErr_no());
            log.error("================= 获取抖店SPU详情失败:message:{}", douDianGoodsDetailVO.getMessage());
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.PULL_GOODS_SPU_DETAIL_FAIL);
        }
        return douDianGoodsDetailVO;
    }

    /**
     * 处理SPU数据
     *
     * @return
     */
    public DoudianGoodsPullRecord handleSpuData(DoudianGoodsPullInfoRequest request, String productId) {
        //获取详情，进行填充
        DouDianGoodsDetailVO douDianGoodsDetailVO = this.pullDoudianDetail(request.getAppKey(), request.getAppSecret(), productId, request.getAccessToken());
        DouDianGoodsDetailDataVO spuDetailData = douDianGoodsDetailVO.getData();

        DoudianGoodsPullRecord goodsPull = new DoudianGoodsPullRecord();
        goodsPull.setProductId(spuDetailData.getProduct_id());
        goodsPull.setOutProductId(spuDetailData.getOut_product_id());
        goodsPull.setOuterProductId(spuDetailData.getOuter_product_id());
        goodsPull.setName(spuDetailData.getName());
        goodsPull.setImg(spuDetailData.getImg());
        goodsPull.setDescription(spuDetailData.getDescription());
        goodsPull.setMobile(spuDetailData.getMobile());
        goodsPull.setRecommendRemark(spuDetailData.getRecommend_remark());
        goodsPull.setMarketPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getMarket_price()).orElse(0L)).movePointLeft(2));
        goodsPull.setDiscountPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getDiscount_price()).orElse(0L)).movePointLeft(2));
        goodsPull.setSettlementPrice(BigDecimal.valueOf(Optional.ofNullable(spuDetailData.getSettlement_price()).orElse(0L)).movePointLeft(2));
        goodsPull.setSpecId(Objects.isNull(spuDetailData.getSpec_id()) ? null : Long.valueOf(spuDetailData.getSpec_id()));
        //填充旧类目id
        goodsPull.setFirstCid(spuDetailData.getFirst_cid());
        goodsPull.setSecondCid(spuDetailData.getSecond_cid());
        goodsPull.setThirdCid(spuDetailData.getThird_cid());
        //填充新的类目
        if (Objects.nonNull(spuDetailData.getCategory_detail())) {
            DoudianGoodsCategoryDetailRecord categoryDetail = new DoudianGoodsCategoryDetailRecord();
            categoryDetail.setFirstCid(spuDetailData.getCategory_detail().getFirst_cid());
            categoryDetail.setSecondCid(spuDetailData.getCategory_detail().getSecond_cid());
            categoryDetail.setThirdCid(spuDetailData.getCategory_detail().getThird_cid());
            categoryDetail.setFourthCid(spuDetailData.getCategory_detail().getFourth_cid());
            categoryDetail.setFirstCname(spuDetailData.getCategory_detail().getFirst_cname());
            categoryDetail.setSecondCname(spuDetailData.getCategory_detail().getSecond_cname());
            categoryDetail.setThirdCname(spuDetailData.getCategory_detail().getThird_cname());
            categoryDetail.setFourthCname(spuDetailData.getCategory_detail().getFourth_cname());
            goodsPull.setCategoryDetail(categoryDetail);
        }
        goodsPull.setStatus(Objects.isNull(spuDetailData.getStatus()) ? null : Integer.valueOf(spuDetailData.getStatus()));
        goodsPull.setCheckStatus(Objects.isNull(spuDetailData.getCheck_status()) ? null : Integer.valueOf(spuDetailData.getCheck_status()));
        goodsPull.setPayType(Objects.isNull(spuDetailData.getPay_type()) ? null : Integer.valueOf(spuDetailData.getPay_type()));
        goodsPull.setExtra(spuDetailData.getExtra());
        goodsPull.setCreateTime(spuDetailData.getCreate_time());
        goodsPull.setUpdateTime(spuDetailData.getUpdate_time());


        //补充SPU详情信息,重新保存
        goodsPull.setPic(spuDetailData.getPic());
        goodsPull.setSpecPics(spuDetailData.getSpec_pics());

        if (StringUtils.isNotEmpty(spuDetailData.getProduct_format())) {
            String replace = spuDetailData.getProduct_format().replace("{", "").replace("}", "")
                    .replace(":", "|").replace("\"", "");
            if (StringUtils.isNotEmpty(replace)) {
                goodsPull.setProductFormat(replace);
            }
        }

        goodsPull.setPresellType(StringUtils.isBlank(spuDetailData.getPresell_type()) ? null : Integer.valueOf(spuDetailData.getPresell_type()));
        goodsPull.setMaximumPerOrder(spuDetailData.getMaximum_per_order());
        goodsPull.setLimitPerBuyer(spuDetailData.getLimit_per_buyer());
        goodsPull.setMinimumPerOrder(spuDetailData.getMinimum_per_order());
        goodsPull.setSpecs(spuDetailData.getSpecs());

        return goodsPull;
    }

    /**
     * 商品资质信息入库
     *
     * @return
     */
    public List<GoodImgRelation> saveQualification(DoudianGoodsPullInfoRequest request, Goods saveGoods, String extra, boolean first) {
        JSONObject extraJson = JSONObject.parseObject(extra);
        //relationQualificationType(0)
        String classQuality = null;
        String qualityReport = null;
        JSONArray qualityList = null;
        if (Objects.nonNull(extraJson)) {
            classQuality = extraJson.getString("class_quality");
            qualityReport = extraJson.getString("quality_report");
            qualityList = extraJson.getJSONArray("quality_list");
        }

        //保存默认法务资质
        QualificationManagementDTO goodsQualification = new QualificationManagementDTO();
        List<GoodImgRelation> goodImgRelationList = new ArrayList<>();
        //校验是否存在资质，不存在则存入默认资质后 结束该方法
        if (CollectionUtils.isEmpty(qualityList) || (StringUtils.isBlank(classQuality) && StringUtils.isBlank(qualityReport))) {

            if (!first) {
                //更新商品则删除旧的资质图
                goodImgRelationRepository.deleteAllByGoodsId(saveGoods.getGoodsId());
                //获取旧的法务资质，用于覆盖更新
                List<QualificationManagementVO> qualificationManagementVOList = qualificationManagementQueryProvider
                        .list(QualificationManagementPageRequest
                                .builder()
                                .relationId(saveGoods.getGoodsId())
                                .qualificationType(0)
                                .relationQualificationType(0)
                                .end(1)
                                .storeId(saveGoods.getStoreId())
                                .build())
                        .getContext()
                        .getQualificationManagementVOList();

                if (CollectionUtils.isNotEmpty(qualificationManagementVOList)) {
                    QualificationManagementVO qualificationManagementVO = qualificationManagementVOList.get(0);
                    KsBeanUtil.copyPropertiesThird(qualificationManagementVO, goodsQualification);
                }
            }
            saveQualificationManagement(first, saveGoods, goodsQualification, QUALIFICA_IMG_LINK);

            GoodImgRelation goodImgRelation = new GoodImgRelation();
            goodImgRelation.setGoodsId(saveGoods.getGoodsId());
            goodImgRelation.setGoodsQualificationImg(QUALIFICA_IMG_LINK);
            goodImgRelation.setDelFlag(DeleteFlag.NO);
            goodImgRelation.setCreateTime(LocalDateTime.now());
            goodImgRelationList.add(goodImgRelation);
        } else {
            StringBuffer sb = new StringBuffer();

            if (StringUtils.isNotBlank(classQuality)) {
                String replace = classQuality.replace(",", "|");
                sb.append(replace).append("|");
            }
            if (StringUtils.isNotBlank(qualityReport)) {
                sb.append(qualityReport).append("|");
            }
            if (sb.length() > 0) {
                sb.deleteCharAt(sb.length() - 1);
            }
            List<QualificationManagementVO> qualificationManagementVOList = qualificationManagementQueryProvider
                    .list(QualificationManagementPageRequest
                            .builder()
                            .relationId(saveGoods.getGoodsId())
                            .qualificationType(0)
                            .relationQualificationType(0)
                            .end(1)
                            .storeId(saveGoods.getStoreId())
                            .build())
                    .getContext()
                    .getQualificationManagementVOList();

            if (CollectionUtils.isNotEmpty(qualificationManagementVOList)) {
                QualificationManagementVO qualificationManagementVO = qualificationManagementVOList.get(0);
                KsBeanUtil.copyPropertiesThird(qualificationManagementVO, goodsQualification);
            }
            //保存法务资质
            saveQualificationManagement(first, saveGoods, goodsQualification, sb.toString());

            goodImgRelationRepository.deleteAllByGoodsId(saveGoods.getGoodsId());
            //资质图片关联
            for (int i = 0; i < qualityList.size(); i++) {
                JSONObject jsonObject = qualityList.getJSONObject(i);
                JSONArray qualityAttachments = jsonObject.getJSONArray("quality_attachments");
                for (int j = 0; j < qualityAttachments.size(); j++) {
                    JSONObject jsonObject1 = qualityAttachments.getJSONObject(j);
                    String url = jsonObject1.getString("url");

                    GoodImgRelation goodImgRelation = new GoodImgRelation();
                    goodImgRelation.setGoodsId(saveGoods.getGoodsId());
                    goodImgRelation.setGoodsQualificationImg(url);
                    goodImgRelation.setDelFlag(DeleteFlag.NO);
                    goodImgRelation.setCreateTime(LocalDateTime.now());
                    goodImgRelationList.add(goodImgRelation);
                }
            }
        }
        return goodImgRelationRepository.saveAll(goodImgRelationList);
    }

    //保存法务资质
    public void saveQualificationManagement(boolean first, Goods saveGoods, QualificationManagementDTO goodsQualification, String picUrl) {
        goodsQualification.setStatus(QualificationStatus.PASS);
        goodsQualification.setEnd(1);
        goodsQualification.setRelationNo(saveGoods.getGoodsNo());
        goodsQualification.setRelationName(saveGoods.getGoodsName());
        goodsQualification.setQualificationType(0);
        goodsQualification.setCompanyName(saveGoods.getSupplierName());
        goodsQualification.setGoodsType(0);
        goodsQualification.setRelationQualificationType(0);
        goodsQualification.setPicUrl(picUrl);
        goodsQualification.setRelationId(saveGoods.getGoodsId());
        goodsQualification.setStoreId(saveGoods.getStoreId());
        goodsQualification.setProviderStandardGoodsId(saveGoods.getStandardGoodsId());
        goodsQualification.setAddStandardGoodsPicUrl(picUrl);
        goodsQualification.setQualificationChangeType(QualificationChangeType.ADD_CREATE_STANDARD);
        goodsQualification.setCreateTime(LocalDateTime.now());
        //新增或不存在资质编号，则进行走新增接口，其余走更新接口
        if (first || StringUtils.isBlank(goodsQualification.getQualificationNo())) {
            BaseResponse<QualificationManagementGetByIdResponse> qualification = qualificationManagementSaveProvider
                    .addOne(QualificationManagementAddOneRequest.builder().qualificationManagementDTO(goodsQualification).build());
            if (Objects.nonNull(qualification.getContext().getQualificationManagementVO())) {
                Integer id = qualification.getContext().getQualificationManagementVO().getId();
                goodsRepository.updateGoodsQulification(saveGoods.getGoodsId(), id);
            }
        }else {
            qualificationManagementSaveProvider.modifyOne(QualificationManagementModifyOneRequest
                    .builder()
                    .qualificationManagementDTO(goodsQualification)
                    .build());
        }
    }

    /**
     * 获取抖店SKU列表
     *
     * @param appKey
     * @param appSecret
     * @param productId
     * @param accessToken
     * @return
     */
    public DouDianSkuListVO pullDoudianSkuList(String appKey, String appSecret, String productId, String accessToken) {
        DouDianSkuListVO douDianSkuListVO = douDianGoodsProvider.skuList(DouDianSkuListRequest
                .builder().product_id(productId)
                .app_key(appKey)
                .app_secret(appSecret)
                .access_token(accessToken)
                .build()).getContext().getDouDianSkuListVO();

        if (douDianSkuListVO.getErr_no() != 0) {
            log.error("================= 错误码:{}", douDianSkuListVO.getErr_no());
            log.error("================= 获取抖店SKU列表失败:message:{}", douDianSkuListVO.getMessage());
            throw new SbcRuntimeException(DoudianGoodsPullErrorCode.PULL_GOODS_SKU_LIST_FAIL);
        }
        return douDianSkuListVO;
    }

    /**
     * 处理抖店sku数据
     *
     * @param skuListVOData
     * @return
     */
    public List<DoudianSkuPullRecord> handleSkuData(List<DouDianSkuListDataVO> skuListVOData) {
        List<DoudianSkuPullRecord> skuPullRecords = new ArrayList<>();
        //填充抖店SKU信息
        skuListVOData.forEach(info -> {
            DoudianSkuPullRecord skuPullRecord = new DoudianSkuPullRecord();
            skuPullRecord.setId(info.getId());
            skuPullRecord.setOpenUserId(info.getOpen_user_id());
            skuPullRecord.setOutSkuId(info.getOut_sku_id());
            skuPullRecord.setProductId(info.getProduct_id());
            skuPullRecord.setSpecDetailId1(info.getSpec_detail_id1());
            skuPullRecord.setSpecDetailId2(info.getSpec_detail_id2());
            skuPullRecord.setSpecDetailId3(info.getSpec_detail_id3());
            skuPullRecord.setSpecDetailName1(info.getSpec_detail_name1());
            skuPullRecord.setSpecDetailName2(info.getSpec_detail_name2());
            skuPullRecord.setSpecDetailName3(info.getSpec_detail_name3());
            skuPullRecord.setStockNum(Long.valueOf(Optional.ofNullable(info.getStock_num()).orElse("0")));
            skuPullRecord.setStepStockNum(Long.valueOf(Optional.ofNullable(info.getStep_stock_num()).orElse("0")));
            Long price = Long.valueOf(Optional.ofNullable(info.getPrice()).orElse("0"));
            skuPullRecord.setPrice(BigDecimal.valueOf(price).movePointLeft(2));
            skuPullRecord.setSpecId(Objects.isNull(info.getSpec_id()) ? null : Long.valueOf(info.getSpec_id()));
            skuPullRecord.setCode(info.getCode());
            skuPullRecord.setSkuType(Integer.valueOf(Optional.ofNullable(info.getSku_type()).orElse("0")));
            skuPullRecord.setSupplierId(info.getSupplier_id());
            skuPullRecord.setStockMap(info.getStock_map());
            skuPullRecord.setCreateTime(info.getCreate_time());
            skuPullRecord.setPreholdStockNum(Long.valueOf(Optional.ofNullable(info.getPrehold_stock_num()).orElse("0")));
            skuPullRecord.setPreholdStepStockNum(Long.valueOf(Optional.ofNullable(info.getPrehold_step_stock_num()).orElse("0")));
            skuPullRecord.setPromStepStockNum(Long.valueOf(Optional.ofNullable(info.getProm_step_stock_num()).orElse("0")));
            skuPullRecord.setPreholdStockMap(info.getPrehold_stock_map());
            skuPullRecords.add(skuPullRecord);
        });
        return skuPullRecords;
    }

    public StandardGoods saveStandardGoods(Goods saveGoods) {
        StandardGoods oldStandardGoods = new StandardGoods();
        String standardGoodsId = saveGoods.getStandardGoodsId();
        StandardGoods standardGoods = new StandardGoods();
        KsBeanUtil.copyPropertiesIgnoreNull(saveGoods, standardGoods);
        standardGoods.setGoodsId(null);
        //添加商品基本信息
        standardGoods.setAuditStatus(CheckStatus.CHECKED);
        standardGoods.setGoodsStatus(Constants.yes);
        standardGoods.setCreateTime(LocalDateTime.now());
        standardGoods.setUpdateTime(LocalDateTime.now());
        standardGoods.setAddedFlag(Constants.yes);
        standardGoods.setDelFlag(DeleteFlag.NO);
        standardGoods.setGoodsAuditStatus(GoodsAuditStatus.PASS);

        if (Objects.isNull(saveGoods.getCateId()) || saveGoods.getCateId() == 0) {
            standardGoods.setCateId(1975L);
        }

        if (Objects.isNull(saveGoods.getBrandId())) {
            //填充默认类目
            GoodsBrand brandListInit = goodsBrandRepository.getBrandListInit();
            standardGoods.setBrandId(brandListInit.getBrandId());
        }else {
            //设置平台的品牌Id
            Optional<ContractBrand> brandByProviderBrandId = contractBrandRepository.findBrandByProviderBrandId(standardGoods.getBrandId());
            if (brandByProviderBrandId.isPresent()) {
                GoodsBrand goodsBrand = brandByProviderBrandId.get().getGoodsBrand();
                if (Objects.isNull(goodsBrand)) {
                    throw new SbcRuntimeException(GoodsErrorCode.EMPTY_BRAND);
                }
                standardGoods.setBrandId(goodsBrand.getBrandId());
            }
        }



        if (StringUtils.isNotBlank(standardGoodsId)) {
            oldStandardGoods = standardGoodsRepository.findById(standardGoodsId).orElse(new StandardGoods());
            String systemGoodsCode = CodeUtils.getStandardGoodsCode();
            standardGoods.setGoodsNo(systemGoodsCode);
            standardGoods.setGoodsId(oldStandardGoods.getGoodsId());
        }
        KsBeanUtil.copyPropertiesIgnoreNull(standardGoods, oldStandardGoods);
        return standardGoodsRepository.save(oldStandardGoods);
    }

    public void saveStandardRel(GoodsRecord goodsRecord, StandardGoods standardGoods) {
        //平台商品图片关联
        List<GoodsImage> goodsImages = goodsRecord.getGoodsImages();
        //standardImageRepository.deleteByGoodsId(standardGoods.getGoodsId());
        List<StandardImage> oldImages = standardImageRepository.findByGoodsId(standardGoods.getGoodsId());
        //过滤出已经删除的图片
        List<StandardImage> oldDeleteImgs = oldImages.stream()
                .filter(item -> !goodsImages.stream().map(GoodsImage::getArtworkUrl).collect(Collectors.toList()).contains(item.getArtworkUrl()))
                .collect(Collectors.toList());
        if (CollectionUtils.isNotEmpty(oldDeleteImgs)) {
            List<Long> deleteImgIds = oldDeleteImgs.stream().map(StandardImage::getImageId).collect(Collectors.toList());
            standardImageRepository.deleteByIds(deleteImgIds);
        }
        //过滤出新增的图片
        List<GoodsImage> newImages = goodsImages.stream()
                .filter(item -> !oldImages.stream().map(StandardImage::getArtworkUrl).collect(Collectors.toList()).contains(item.getArtworkUrl()))
                .collect(Collectors.toList());
        for (GoodsImage goodsImage : newImages) {
            StandardImage image = new StandardImage();
            image.setGoodsId(standardGoods.getGoodsId());
            image.setArtworkUrl(goodsImage.getArtworkUrl());
            image.setUpdateTime(LocalDateTime.now());
            image.setDelFlag(DeleteFlag.NO);
            image.setCreateTime(LocalDateTime.now());
            standardImageRepository.save(image);
        }

        //平台商品属性关联
        List<GoodsPropRelation> goodsPropRelList = goodsRecord.getPropRelationList();
        List<StandardGoodsPropRelation> oldProps = standardGoodsPropRelationService.findByGoodsId(standardGoods.getGoodsId());
        //过滤出已删除的属性关联
        List<StandardGoodsPropRelation> oldDeleteProps = oldProps.stream()
                .filter(item -> !goodsPropRelList.stream().map(GoodsPropRelation::getPropValue).collect(Collectors.toList()).contains(item.getPropValue()))
                .collect(Collectors.toList());
        if (CollectionUtils.isNotEmpty(oldDeleteProps)) {
            List<Long> deletePropIds = oldDeleteProps.stream().map(StandardGoodsPropRelation::getId).collect(Collectors.toList());
            standardGoodsPropRelationService.deleteByIds(deletePropIds);
        }
        //过滤出新增的属性关联
        List<GoodsPropRelation> newProps = goodsPropRelList.stream()
                .filter(item -> !oldDeleteProps.stream().map(StandardGoodsPropRelation::getPropValue).collect(Collectors.toList()).contains(item.getPropValue()))
                .collect(Collectors.toList());
        for (GoodsPropRelation propRelation : newProps) {
            StandardGoodsPropRelation standardPropRel = new StandardGoodsPropRelation();
            KsBeanUtil.copyProperties(propRelation, standardPropRel);
            standardPropRel.setGoodsId(standardGoods.getGoodsId());
            standardPropRel.setCreateTime(LocalDateTime.now());
            standardPropRel.setStartTime(LocalDateTime.now());
            standardPropRel.setDelFlag(DeleteFlag.NO);
            standardPropRel.setGoodsId(standardGoods.getGoodsId());
            standardPropRel.setId(null);
            standardGoodsPropRelationService.add(standardPropRel);
        }

        //平台规格关联
        List<GoodsSaleRel> goodsSaleRels = goodsRecord.getGoodsSaleRels();
        List<StandardGoodsSaleRel> oldStandardSaleRels = standardGoodsSaleRelService.getByGoodsId(standardGoods.getGoodsId());
        //过滤出删除的规格
        List<StandardGoodsSaleRel> oldSale = oldStandardSaleRels.stream()
                .filter(item -> !goodsSaleRels.stream().map(GoodsSaleRel::getSaleName).collect(Collectors.toList()).contains(item.getSaleName()))
                .collect(Collectors.toList());
        //删除掉已经删除的规格关联关系
        if (CollectionUtils.isNotEmpty(oldSale)) {
            List<Long> deleteSaleId = oldSale.stream().map(StandardGoodsSaleRel::getId).collect(Collectors.toList());
            standardGoodsSaleRelService.deleteByIdList(deleteSaleId);
        }
        //过滤出新增的，进行新增
        List<GoodsSaleRel> newSale = goodsSaleRels.stream()
                .filter(item -> !oldStandardSaleRels.stream().map(StandardGoodsSaleRel::getSaleName).collect(Collectors.toList()).contains(item.getSaleName()))
                .collect(Collectors.toList());
        List<StandardGoodsSaleRel> standardSaleRelList = new ArrayList<>();
        for (GoodsSaleRel goodsSaleRel : newSale) {
            StandardGoodsSaleRel standardGoodsSaleRel = new StandardGoodsSaleRel();
            KsBeanUtil.copyProperties(goodsSaleRel, standardGoodsSaleRel);
            standardGoodsSaleRel.setCreateTime(LocalDateTime.now());
            standardGoodsSaleRel.setDelFlag(DeleteFlag.NO);
            standardGoodsSaleRel.setStandardGoodsId(standardGoods.getGoodsId());
            standardGoodsSaleRel.setId(null);
            standardSaleRelList.add(standardGoodsSaleRel);
        }
        standardGoodsSaleRelService.addAll(standardSaleRelList);

        //获取供应商商品资质
        List<GoodImgRelation> goodImgRelations = goodsRecord.getGoodImgRelations();
        List<StandardGoodImgRelation> oldGoodImgRelations = standardGoodImgRelationService.findByGoodsId(standardGoods.getGoodsId());
        //过滤出删除的资质
        List<StandardGoodImgRelation> oldDeleteGoodsImgRel = oldGoodImgRelations.stream()
                .filter(item -> !goodImgRelations.stream().map(GoodImgRelation::getGoodsQualificationImg).collect(Collectors.toList()).contains(item.getGoodsQualificationImg()))
                .collect(Collectors.toList());
        //删除掉已经删除的资质
        if (CollectionUtils.isNotEmpty(oldDeleteGoodsImgRel)) {
            List<Long> deleteId = oldDeleteGoodsImgRel.stream().map(StandardGoodImgRelation::getImgId).collect(Collectors.toList());
            standardGoodImgRelationService.deleteByIds(deleteId);
        }
        //过滤出新增的，进行新增
        List<GoodImgRelation> newGoodsImgRel = goodImgRelations.stream()
                .filter(item -> !oldGoodImgRelations.stream().map(StandardGoodImgRelation::getGoodsQualificationImg).collect(Collectors.toList()).contains(item.getGoodsQualificationImg()))
                .collect(Collectors.toList());
        List<StandardGoodImgRelation> standardGoodImgRelationList = new ArrayList<>();
        newGoodsImgRel.forEach(item -> {
            StandardGoodImgRelation standardGoodImgRelation = new StandardGoodImgRelation();
            KsBeanUtil.copyProperties(item, standardGoodImgRelation);
            standardGoodImgRelation.setGoodsId(standardGoods.getGoodsId());
            standardGoodImgRelation.setDelFlag(DeleteFlag.NO);
            standardGoodImgRelation.setCreateTime(LocalDateTime.now());
            standardGoodImgRelation.setImgId(null);
            standardGoodImgRelationList.add(standardGoodImgRelation);
        });
        standardGoodImgRelationService.addAll(standardGoodImgRelationList);
    }


    //抖店商品详细 - 测试数据
    public DouDianGoodsDetailDataVO mockDoudianDetail() {
        DouDianGoodsPageVO douDianGoodsPageVO = new DouDianGoodsPageVO();
        DouDianGoodsDetailDataVO dataVO = new DouDianGoodsDetailDataVO();
        List<String> pic = new ArrayList<>();
        pic.add("https://xingye-online.oss-cn-beijing.aliyuncs.com/568b5f48cd679bd8ec5fa8cd840f06ae.jpg");
        pic.add("https://xingye-online.oss-cn-beijing.aliyuncs.com/456e5c81bd9ae2f7c9125e762a24d59b.png");
        dataVO.setPic(pic);
        dataVO.setProduct_format("{\"货号\":\"8888\"}");
        dataVO.setPresell_type("0");

        List<DouDianSpecDetailVO> specs = new ArrayList<>();
        DouDianSpecDetailVO spec = new DouDianSpecDetailVO();

        List<DouDianSpecDetaiValueVO> specValues = new ArrayList<>();
        for (int i = 0; i < 1; i++) {
            DouDianSpecDetaiValueVO specValue = new DouDianSpecDetaiValueVO();
            specValue.setName("抖店规格值 - " + i);
            specValues.add(specValue);
        }
        spec.setName("抖店规格项 - 1");
        spec.setValues(specValues);

        dataVO.setSpecs(specs);
        return dataVO;
    }

    //抖店商品SKU - 测试数据
    public List<DoudianSkuPullRecord> mockDoudianSku(DouDianGoodsDetailDataVO dataVO) {
        List<DoudianSkuPullRecord> skuPullRecords = new ArrayList<>();
        //填充抖店SKU信息
        for (int i = 0; i < 1; i++) {
            DoudianSkuPullRecord skuPullRecord = new DoudianSkuPullRecord();
            skuPullRecord.setId("1" + dataVO.getProduct_id());
            skuPullRecord.setOpenUserId("000" + i);
            skuPullRecord.setOutSkuId(dataVO.getProduct_id());
            skuPullRecord.setProductId(dataVO.getProduct_id());
            skuPullRecord.setSpecDetailName1("抖店规格值 - " + 0);
            skuPullRecord.setSpecDetailName2("抖店规格值 - " + 1);
            skuPullRecord.setStockNum(0L);
            skuPullRecord.setStepStockNum(10L);
            skuPullRecord.setPrice(BigDecimal.valueOf(10));
            skuPullRecord.setSkuType(0);
            skuPullRecord.setCreateTime(LocalDateTime.now());
            skuPullRecords.add(skuPullRecord);
        }
        return skuPullRecords;
    }
}

```



##### 发送MQ

```java
String json = JSONObject.toJSONString(request);
//发送MQ消息
boolean flag = doudianGoodsPullSink.output().send(MessageBuilder.withPayload(request).build());
```



##### DoudianGoodsPullSink

```java
package com.wanmi.sbc.goods.mq;


import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.cloud.stream.annotation.Input;
import org.springframework.cloud.stream.annotation.Output;
import org.springframework.messaging.MessageChannel;
import org.springframework.messaging.SubscribableChannel;

/**
 * @author: liuwei
 * @createDate: 2021/5/17 13:58
 * @version: 1.0
 */
@EnableBinding
public interface DoudianGoodsPullSink {

    /**
     * 接受消息
     */
    String Q_DOUDIAN_GOODS_PULL_INPUT = "q-goods-doudian-goods-pull-input";

    /**
     * 发送消息
     */
    String Q_DOUDIAN_GOODS_PULL_OUTPUT = "q-goods-doudian-goods-pull-output";

    /**
     * 接受消息 - 根据地抖店商品id获取抖店商品
     */
    String Q_BY_DOUDIAN_GOODS_ID_PULL_INPUT = "q-goods-by-doudian-goods-id-pull-input";

    /**
     * 发送消息 - 根据地抖店商品id获取抖店商品
     */
    String Q_BY_DOUDIAN_GOODS_ID_PULL_OUTPUT = "q-goods-by-doudian-goods-id-pull-output";


    /**
     * 接受消息 - 失败商品重新拉取
     */
    String Q_FAIL_GOODS_AGAIN_PULL_INPUT = "q-goods-fail-goods-again-pull-input";

    /**
     * 发送消息 - 失败商品重新拉取
     */
    String Q_FAIL_GOODS_AGAIN_PULL_OUTPUT = "q-goods-fail-goods-again-pull-output";

    @Input(Q_DOUDIAN_GOODS_PULL_INPUT)
    SubscribableChannel input();

    @Output(Q_DOUDIAN_GOODS_PULL_OUTPUT)
    MessageChannel output();

    @Input(Q_BY_DOUDIAN_GOODS_ID_PULL_INPUT)
    SubscribableChannel inputByIdPullGoods();

    @Output(Q_BY_DOUDIAN_GOODS_ID_PULL_OUTPUT)
    MessageChannel outputByIdPullGoods();

    //失败商品重新拉取 - 接收消息
    @Input(Q_FAIL_GOODS_AGAIN_PULL_INPUT)
    SubscribableChannel failAgainPullInput();

    //失败商品重新拉取 - 发送消息
    @Output(Q_FAIL_GOODS_AGAIN_PULL_OUTPUT)
    MessageChannel failAgainPullOutput();

}

```



##### 接收者

```java
package com.wanmi.sbc.goods.mq;

import com.alibaba.fastjson.JSONObject;
import com.wanmi.sbc.common.enums.DeleteFlag;
import com.wanmi.sbc.goods.api.constant.DoudianGoodsPullConst;
import com.wanmi.sbc.goods.api.request.doudiangoodspull.DoudianGoodsPullInfoRequest;
import com.wanmi.sbc.goods.doudiangoodspullrecord.root.DoudianPullFailReasonRecord;
import com.wanmi.sbc.goods.doudiangoodspullrecord.service.DoudianGoodsPullService;
import com.wanmi.sbc.goods.doudiangoodspullrecord.service.DoudianPullFailReasonRecordService;
import com.wanmi.sbc.goods.redis.RedisService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.cloud.stream.annotation.EnableBinding;
import org.springframework.cloud.stream.annotation.StreamListener;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;

/**
 * @author: liuwei
 * @createDate: 2021/5/17 13:58
 * @version: 1.00
 */
@Slf4j
@Component
@EnableBinding(DoudianGoodsPullSink.class)
public class DoudianGoodsPullConsumer {

    @Autowired
    DoudianGoodsPullService doudianGoodsPullService;

    @Autowired
    private RedisService redisService;

    @Autowired
    private DoudianPullFailReasonRecordService doudianPullFailReasonRecordService;

    @StreamListener(DoudianGoodsPullSink.Q_DOUDIAN_GOODS_PULL_INPUT)
    public void input(String json){
        try {
            log.info("=========================== 抖店商品同步MQ消息已接收,参数：{} ===========================" ,json);
            DoudianGoodsPullInfoRequest request = JSONObject.parseObject(json, DoudianGoodsPullInfoRequest.class);

            try {
                //删除上一次拉取的失败原因记录
                doudianPullFailReasonRecordService.deleteByShopInfoId(request.getShopInfoId());
                //开始同步
                doudianGoodsPullService.pullDoudianGoods(request);
            } catch (Exception e) {
                //失败则变更状态为0
                String pullStatusKey = DoudianGoodsPullConst.PULL_STATUS_KEY + request.getShopInfoId();
                redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_START_FIELD, "0");
                redisService.hset(pullStatusKey, DoudianGoodsPullConst.PULL_IS_FINISH_FIELD, "1");
                log.error("抖店商品同步，发生异常! param={}", json, e);

                //记录失败原因
                String failReason = "其他原因导致同步失败";
                failReasonHandle(request.getShopInfoId(), e, failReason);
            }
            /*
            new Thread(new Runnable() {
                @Override
                public void run() {
                    doudianGoodsPullService.pullDoudianGoods(request);
//                    log.info("抖店商品同步，参数详细信息：{}",json);
                }
            }).start();
            */
        } catch (Exception e) {
            log.error("抖店同步MQ消息接收，发生异常! param={}", json, e);
        }
    }

    @StreamListener(DoudianGoodsPullSink.Q_BY_DOUDIAN_GOODS_ID_PULL_INPUT)
    public void inputByIdPullGoods(String json){
        try {
            log.info("=========================== 抖店商品同步MQ消息已接收,参数：{} ===========================" ,json);
            DoudianGoodsPullInfoRequest request = JSONObject.parseObject(json, DoudianGoodsPullInfoRequest.class);
            doudianGoodsPullService.byIdPullGoods(request);
            log.info("抖店商品同步，参数详细信息：{}",json);
        } catch (Exception e) {
            log.error("抖店商品同步，发生异常! param={}", json, e);
        }
    }

    @StreamListener(DoudianGoodsPullSink.Q_FAIL_GOODS_AGAIN_PULL_INPUT)
    public void failAgainPullInput(String json){
        try {
            log.info("=========================== 抖店商品同步MQ消息已接收,参数：{} ===========================" ,json);
            DoudianGoodsPullInfoRequest request = JSONObject.parseObject(json, DoudianGoodsPullInfoRequest.class);
            doudianGoodsPullService.failGoodsAgainPull(request);
            log.info("抖店商品同步，参数详细信息：{}",json);
        } catch (Exception e) {
            log.error("抖店商品同步，发生异常! param={}", json, e);
        }
    }


    //失败原因处理
    public void failReasonHandle(Integer shopInfoId, Exception e, String failReason) {
        DoudianPullFailReasonRecord failInfoRecord = new DoudianPullFailReasonRecord();
        failInfoRecord.setShopInfoId(shopInfoId);
        failInfoRecord.setFailReason(failReason);
        failInfoRecord.setFailMessage(e.getMessage());
        failInfoRecord.setCreatTime(LocalDateTime.now());
        failInfoRecord.setDelFlag(DeleteFlag.NO);
        doudianPullFailReasonRecordService.save(failInfoRecord);
    }
}

```



##### 参考茂盛的

```java
package com.wanmi.sbc.goods.callpartner.service;

import com.alibaba.fastjson.JSON;
import com.alibaba.fastjson.serializer.SerializerFeature;
import com.wanmi.sbc.common.util.CommonErrorCode;
import com.wanmi.sbc.common.util.UUIDUtil;
import com.wanmi.sbc.goods.api.request.callpartner.*;
import com.wanmi.sbc.goods.bean.enums.MessageType;
import com.wanmi.sbc.goods.bean.enums.MinDaoYunControlType;
import com.wanmi.sbc.goods.callpartner.model.root.CallPartnerRecord;
import com.wanmi.sbc.goods.callpartner.repository.CallPartnerUrlRecordRepository;
import com.wanmi.sbc.goods.bean.enums.CallPartnerStatus;
import com.wanmi.sbc.goods.api.response.callpartner.CallPartnerUrlResponse;
import com.wanmi.sbc.goods.mq.CallPartnerUrlSink;
import lombok.extern.slf4j.Slf4j;
import org.apache.commons.collections4.CollectionUtils;
import org.apache.commons.lang3.ArrayUtils;
import org.apache.commons.lang3.StringUtils;
import org.apache.http.HttpEntity;
import org.apache.http.HttpResponse;
import org.apache.http.HttpStatus;
import org.apache.http.client.methods.HttpGet;
import org.apache.http.client.methods.HttpPost;
import org.apache.http.entity.ContentType;
import org.apache.http.entity.StringEntity;
import org.apache.http.impl.client.CloseableHttpClient;
import org.apache.http.impl.client.HttpClientBuilder;
import org.apache.http.util.EntityUtils;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.integration.support.MessageBuilder;
import org.springframework.messaging.Message;
import org.springframework.stereotype.Service;

import java.io.IOException;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.time.LocalDateTime;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.Objects;

/**
 * 调用第三方接口
 */
@Service
@Slf4j
public class CallPartnerUrlService {

    /**
     * 成功标识
     */
    private static final String SUCCESS_TAG = "SUCCESS";

    /**
     * 消息重试步长
     */
    private static final int MESSAGE_RETRY_STEP = 1;

    /**
     * 最大重试次数x
     */
    private static final int MAX_RETRY_TIMES = 3;

    /**
     * 延迟重试步长，单位：秒
     */
    private static final int DELAY_TIME_STEP = 10;

    /**
     * 零延迟消息
     */
    private static final int NO_DELAY = 0;

    /**
     * 延迟时间度量值
     */
    private static final int DELAY_TIME_METRIC = 1000;

    private static final String DELAY_MESSAGE_HEADER_TAG = "x-delay";

    @Value("${call.partner.url.mindaoyun}")
    private String callPartnerUrlMinDaoYun;

    @Value("${call.partner.appkey.mindaoyun}")
    private String callPartnerAppkeyMinDaoYun;

    @Value("${call.partner.secret.mindaoyun}")
    private String callPartnerSecretMinDaoYun;

    @Value("${call.partner.sign.mindaoyun}")
    private String callPartnerSignMinDaoYun;

    @Value("${call.partner.worksheetId.mindaoyun}")
    private String callPartnerWorksheetIdMinDaoYun;

    @Value("${call.partner.valueControlId.mindaoyun}")
    private String callPartnerValueControlIdMinDaoYun;

    @Value("${call.partner.typeControlId.mindaoyun}")
    private String callPartnerTypeControlIdMinDaoYun;

    @Autowired
    private CallPartnerUrlSink callPartnerUrlSink;

    @Autowired
    private CallPartnerUrlRecordRepository callPartnerUrlRecordRepository;

    /**
     * 执行调用第三个API
     * 1. 处理业务逻辑
     * 2. 调用API
     * 3. 处理失败情况
     * - 记录
     * - 延迟补偿
     *
     * @param json
     */
    public void doCallPartner(String json) {

        if (StringUtils.isEmpty(json)) {
            return;
        }

        CallPartnerUrlMessage callPartnerUrlMessage = null;
        try {
            // 数据转换
            callPartnerUrlMessage = JSON.parseObject(json, CallPartnerUrlMessage.class);
        } catch (Exception e) {
            e.printStackTrace();
        }

        if (Objects.isNull(callPartnerUrlMessage)) {
            return;
        }

        switch (callPartnerUrlMessage.getMessageType()) {
            case MIN_DAO_YUN:
                doCallMindDaoYunUrl(callPartnerUrlMessage);
                break;
            default:
                break;
        }

    }

    /**
     * 调用明道云
     * @param callPartnerUrlMessage
     */
    public void doCallMindDaoYunUrl(CallPartnerUrlMessage callPartnerUrlMessage) {
        String messageBody = callPartnerUrlMessage.getMessageBody();
        String url = callPartnerUrlMinDaoYun;

        if (StringUtils.isEmpty(url) || StringUtils.isEmpty(messageBody)) {
            // 记录空数据
            return;
        }
        MinDaoYunResponse minDaoYunResponse = doPostBusinessTranslate(callPartnerUrlMessage, url, messageBody, MinDaoYunResponse.class);
        if (Objects.isNull(minDaoYunResponse) || !minDaoYunResponse.isSuccess()) {
            // 返回状态码错误，进行消息补偿
            sendRetryMessage(callPartnerUrlMessage);
        }
    }

    /**
     * 发送报价单信息至明道云
     * @param minDaoYunQuotationMessageRequest
     * @return
     */
    public boolean sendMinDaoYunQuotationMessage(MinDaoYunQuotationMessageRequest minDaoYunQuotationMessageRequest){
        MinDaoYunMessageRequest minDaoYunMessageRequest = MinDaoYunMessageRequest.builder()
                .appKey(callPartnerAppkeyMinDaoYun)
                .worksheetId(callPartnerWorksheetIdMinDaoYun)
                .sign(callPartnerSignMinDaoYun)
                .controls(doMinDaoYunWrapperControl(Collections.singletonList(minDaoYunQuotationMessageRequest)
                        ,MinDaoYunControlType.QUOTATION))
                .build();
        return sendMindDaoYunMessage(JSON.toJSONString(minDaoYunMessageRequest, SerializerFeature.WriteMapNullValue));
    }
    /**
     * 发送报价单信息至明道云
     * @param minDaoYunQuotationMessageRequest
     * @return
     */
    public boolean sendMinDaoYunGoodsMessage(MinDaoYunQuotationMessageRequest minDaoYunQuotationMessageRequest){
        MinDaoYunMessageRequest minDaoYunMessageRequest = MinDaoYunMessageRequest.builder()
                .appKey(callPartnerAppkeyMinDaoYun)
                .worksheetId(callPartnerWorksheetIdMinDaoYun)
                .sign(callPartnerSignMinDaoYun)
                .controls(doMinDaoYunWrapperControl(Collections.singletonList(minDaoYunQuotationMessageRequest)
                        ,MinDaoYunControlType.GOODS))
                .build();
        return sendMindDaoYunMessage(JSON.toJSONString(minDaoYunMessageRequest, SerializerFeature.WriteMapNullValue));
    }

    /**
     * 发送场次调整信息至明道云
     * @param minDaoYunInvestmentMessageRequest
     * @return
     */
    public boolean sendMinDaoYunInvestmentMessage(MinDaoYunInvestmentMessageRequest minDaoYunInvestmentMessageRequest){
        return batchSendMinDaoYunInvestmentMessage(Collections.singletonList(minDaoYunInvestmentMessageRequest));
    }

    /**
     * 批量发送场次调整信息至明道云
     *
     * @param minDaoYunInvestmentMessageRequests
     * @return
     */
    public boolean batchSendMinDaoYunInvestmentMessage(List<MinDaoYunInvestmentMessageRequest> minDaoYunInvestmentMessageRequests) {
        MinDaoYunMessageRequest minDaoYunMessageRequest = MinDaoYunMessageRequest.builder()
                .appKey(callPartnerAppkeyMinDaoYun)
                .worksheetId(callPartnerWorksheetIdMinDaoYun)
                .sign(callPartnerSignMinDaoYun)
                .controls(doMinDaoYunWrapperControl(minDaoYunInvestmentMessageRequests,MinDaoYunControlType.INVESTMENT))
                .build();
        return sendMindDaoYunMessage(JSON.toJSONString(minDaoYunMessageRequest,SerializerFeature.WriteMapNullValue));
    }

    /**
     * 团长自动化-发送报价单信息至明道云
     * @param minDaoYunCaptainQuotationMessageRequest
     * @return
     */
    public boolean sendMinDaoYunCaptainQuotationMessage(MinDaoYunCaptainQuotationMessageRequest minDaoYunCaptainQuotationMessageRequest , MinDaoYunControlType type){
        MinDaoYunMessageRequest minDaoYunMessageRequest = MinDaoYunMessageRequest.builder()
                .appKey(callPartnerAppkeyMinDaoYun)
                .worksheetId(callPartnerWorksheetIdMinDaoYun)
                .sign(callPartnerSignMinDaoYun)
                .controls(doMinDaoYunWrapperControl(Collections.singletonList(minDaoYunCaptainQuotationMessageRequest)
                        ,type))
                .build();
        return sendMindDaoYunMessage(JSON.toJSONString(minDaoYunMessageRequest, SerializerFeature.WriteMapNullValue));
    }

    private <T> List<MinDaoYunControlRequest> doMinDaoYunWrapperControl(
            List<T> requests,
            MinDaoYunControlType minDaoYunControlType
    ){
        List<MinDaoYunControlRequest> contols = new ArrayList<>();
        contols.add(MinDaoYunControlRequest.builder()
                .controlId(callPartnerValueControlIdMinDaoYun)
                .value(JSON.toJSONString(requests,SerializerFeature.WriteMapNullValue))
                .build());
        contols.add(MinDaoYunControlRequest.builder()
                .controlId(callPartnerTypeControlIdMinDaoYun)
                .value(minDaoYunControlType.getDescription())
                .build());
        return contols;
    }

    /**
     * 发送消息至明道云
     * @param messageBody
     * @return
     */
    public boolean sendMindDaoYunMessage(String messageBody){
        CallPartnerUrlMessage message = CallPartnerUrlMessage.builder()
                .id(UUIDUtil.getUUID())
                .firstTime(LocalDateTime.now())
                .lastTime(LocalDateTime.now())
                .retryTimes(0)
                .messageType(MessageType.MIN_DAO_YUN)
                .messageBody(messageBody)
                .build();
        return sendCallPartnerMessage(message);
    }

    /**
     * 发送调用消息
     * @param callPartnerUrlMessage
     * @return
     */
    public boolean sendCallPartnerMessage(CallPartnerUrlMessage callPartnerUrlMessage){
        Message<CallPartnerUrlMessage> message =
                MessageBuilder
                        .withPayload(callPartnerUrlMessage)
                        .setHeader(DELAY_MESSAGE_HEADER_TAG, NO_DELAY)
                        .build();
       return  callPartnerUrlSink.output().send(message);
    }

    /**
     * 发送延迟消息
     * @param callPartnerUrlMessage
     * @param delayTime
     * @return
     */
    public boolean sendDelayMessage(CallPartnerUrlMessage callPartnerUrlMessage, int delayTime){
        // 发送延迟消息
        Message<CallPartnerUrlMessage> message =
                MessageBuilder
                        .withPayload(callPartnerUrlMessage)
                        .setHeader(DELAY_MESSAGE_HEADER_TAG, delayTime)
                        .build();
        boolean send = callPartnerUrlSink.output().send(message);
        log.info("调用第三方接口发送补偿消息结果：{}，补偿次数{}，消息发送{}，",
                send,
                callPartnerUrlMessage.getRetryTimes() + MESSAGE_RETRY_STEP
                , message
        );
        return send;
    }

    /**
     * 发送重试消息
     * @param callPartnerUrlMessage
     * @return
     */
    private boolean sendRetryMessage(CallPartnerUrlMessage callPartnerUrlMessage) {
        if (MAX_RETRY_TIMES < callPartnerUrlMessage.getRetryTimes() + MESSAGE_RETRY_STEP) {
            log.debug("超过最大补偿次数：{}", callPartnerUrlMessage.getRetryTimes());
            // 记录日志
            callPartnerUrlRecordRepository.save(CallPartnerRecord.builder().id(UUIDUtil.getUUID())
                    .callPartnerUrlMessage(callPartnerUrlMessage).callPartnerStatus(CallPartnerStatus.OUT_OF_RETRY_TIMES).build());
            return false;
        }
        boolean send = sendDelayMessage( CallPartnerUrlMessage.builder()
                .firstTime(callPartnerUrlMessage.getFirstTime())
                .lastTime(LocalDateTime.now())
                .retryTimes(callPartnerUrlMessage.getRetryTimes() + MESSAGE_RETRY_STEP)
                .messageType(callPartnerUrlMessage.getMessageType())
                .messageBody(callPartnerUrlMessage.getMessageBody())
                .build(),DELAY_TIME_METRIC * DELAY_TIME_STEP * callPartnerUrlMessage.getRetryTimes());

        return send;
    }

    /**
     * post调用第三方接口，并进行业务转换处理
     *
     * @param url
     * @param requestBody
     * @param tClass
     * @param <T>
     * @return
     */
    private  <T> T doPostBusinessTranslate(CallPartnerUrlMessage callPartnerUrlMessage, String url, String requestBody, Class<T> tClass) {
        CallPartnerUrlResponse callPartnerUrlResponse = doPost(url, requestBody, callPartnerUrlMessage.getId());
        log.debug("请求响应：{}", callPartnerUrlResponse);
        if (Objects.isNull(callPartnerUrlResponse)) {
            // 未拿到请求响应
            // 记录失败
            callPartnerUrlRecordRepository.save(CallPartnerRecord.builder().id(UUIDUtil.getUUID())
                    .callPartnerUrlMessage(callPartnerUrlMessage).messageResponse(null).callPartnerStatus(CallPartnerStatus.FAILURE).build());
            return null;
        }

        if (CommonErrorCode.FAILED.equals(callPartnerUrlResponse.getCode())) {
            // 记录错误
            log.debug("接口调用失败：{}", callPartnerUrlMessage);
            // 记录失败
            callPartnerUrlRecordRepository.save(CallPartnerRecord.builder().id(UUIDUtil.getUUID())
                    .callPartnerUrlMessage(callPartnerUrlMessage).messageResponse(callPartnerUrlResponse).callPartnerStatus(CallPartnerStatus.FAILURE).build());
            return null;
        }

        if (HttpStatus.SC_OK != callPartnerUrlResponse.getHttpStatus()) {
            // 接口请求失败，响应码错误，重试
            log.debug("接口请求失败，响应码错误，重试：{}", callPartnerUrlMessage);
            // 记录失败
            callPartnerUrlRecordRepository.save(CallPartnerRecord.builder().id(UUIDUtil.getUUID())
                    .callPartnerUrlMessage(callPartnerUrlMessage).messageResponse(callPartnerUrlResponse).callPartnerStatus(CallPartnerStatus.FAILURE).build());
            return null;
        }

        String message = callPartnerUrlResponse.getMessage();
        // 接口请求成功，记录
        callPartnerUrlRecordRepository.save(CallPartnerRecord.builder().id(UUIDUtil.getUUID())
                .callPartnerUrlMessage(callPartnerUrlMessage)
                .callPartnerStatus(CallPartnerStatus.SUCCESS)
                .messageResponse(callPartnerUrlResponse).build());
        return tClass == String.class ? (T) message : JSON.parseObject(message, tClass);
    }

    /**
     * post请求
     *
     * @param url         请求地址
     * @param requestBody json格式的参数
     * @return JSONObject返回对象
     */
    private CallPartnerUrlResponse doPost(String url, String requestBody, String messageId) {
        log.debug("请求信息，消息ID：{}，地址：{}，内容：{}，", messageId, url, requestBody);
        CloseableHttpClient httpClient = HttpClientBuilder.create().build();
        HttpPost post = new HttpPost(url);
        try {
            post.addHeader("Content-type", ContentType.APPLICATION_JSON.toString());
            post.setHeader("Accept", "application/json");
            post.setHeader("message-id", messageId);
            post.setEntity(new StringEntity(requestBody, StandardCharsets.UTF_8));
            HttpResponse res = httpClient.execute(post);
            return CallPartnerUrlResponse.builder()
                    .code(CommonErrorCode.SUCCESSFUL)
                    .httpStatus(res.getStatusLine().getStatusCode())
                    .message(EntityUtils.toString(res.getEntity()))
                    .build();
        } catch (IOException e) {
            e.printStackTrace();
            return CallPartnerUrlResponse.builder()
                    .code(CommonErrorCode.FAILED)
                    .exception(JSON.toJSONString(e,SerializerFeature.WriteMapNullValue))
                    .build();
        } finally {
            try {
                httpClient.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
    }

    /**
     * get请求，参数拼接在地址上
     *
     * @param methodUrl 请求地址加参数
     * @return 字符串类型的返回值
     */
    private String doGet(String methodUrl) {
        CloseableHttpClient httpClient = HttpClientBuilder.create().build();
        try {
            URL url = new URL(methodUrl);
            HttpGet get = new HttpGet(String.valueOf(url));
            HttpResponse response = httpClient.execute(get);
            if (response != null && response.getStatusLine().getStatusCode() == 200) {
                HttpEntity entity = response.getEntity();
                return EntityUtils.toString(entity);
            }
        } catch (Exception e) {
            throw new RuntimeException(e);
        } finally {
            try {
                httpClient.close();
            } catch (IOException e) {
                e.printStackTrace();
            }
        }
        return null;
    }

}

```

